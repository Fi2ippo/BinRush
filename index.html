<!DOCTYPE html>
<html lang="it">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BINRUSH – Allenamento Binario</title>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #070B0A;
      --bg2: #0C1210;
      --bg3: #131C18;
      --bg-input: #0F1613;
      --border: rgba(234, 246, 238, 0.08);
      --border-hi: rgba(63, 226, 138, 0.5);
      --text: #EAF6EE;
      --text-dim: rgba(234, 246, 238, 0.35);
      --text-mid: rgba(234, 246, 238, 0.55);
      --text-bright: #fff;
      --accent: #3FE28A;
      --accent-dim: #34c97d;
      --accent-soft: rgba(63, 226, 138, 0.08);
      --accent-glow: rgba(63, 226, 138, 0.15);
      --accent2: #0ff;
      --accent3: #f0f;
      --info: #34D7FF;
      --duel: #9B86FF;
      --duel-glow: rgba(155, 134, 255, 0.15);
      --danger: #FF4D4D;
      --warning: #FFD166;
      --glow: 0 0 20px var(--accent-glow);
      --glow-sm: 0 0 10px var(--accent-glow);
      --focus-ring: 0 0 0 2px var(--accent-glow);
      --radius: 12px;
      --radius-master: 20px;
      --border-w: 1px;
      --font: 'JetBrains Mono', 'Courier New', 'Lucida Console', monospace;
      --font-display: system-ui, -apple-system, sans-serif;
      --shadow-glass: 0 8px 32px rgba(0, 0, 0, 0.37);
      --shadow-soft: 0 0 15px rgba(0, 0, 0, 0.2);
    }

    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0
    }

    body {
      font-family: var(--font);
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
      position: relative
    }

    body::before {
      content: '';
      position: fixed;
      inset: 0;
      z-index: 0;
      pointer-events: none;
      background-size: 40px 40px;
      background-image: linear-gradient(to right, rgba(234, 246, 238, 0.03) 1px, transparent 1px), linear-gradient(to bottom, rgba(234, 246, 238, 0.03) 1px, transparent 1px);
      opacity: 0.3
    }

    .app {
      position: relative;
      z-index: 1;
      min-height: 100vh;
      display: flex;
      flex-direction: column
    }

    .screen {
      display: none;
      flex: 1;
      padding: 24px;
      max-width: 1100px;
      width: 100%;
      margin: 0 auto
    }

    .screen.active {
      display: flex;
      flex-direction: column
    }

    /* HEADER */
    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 24px;
      background: transparent;
      max-width: 1200px;
      margin: 0 auto;
      width: 100%
    }

    .topbar .logo {
      font-size: 1.2rem;
      font-weight: 700;
      letter-spacing: .2em;
      color: var(--text);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: color .3s
    }

    .topbar .logo:hover {
      color: var(--accent)
    }

    .topbar .logo span {
      color: var(--accent)
    }

    .topbar-right {
      display: flex;
      gap: 16px;
      align-items: center
    }

    .topbar-right>button {
      background: rgba(12, 18, 16, 0.3);
      border: 1px solid var(--border);
      color: var(--text-dim);
      padding: 10px;
      cursor: pointer;
      font-family: var(--font);
      font-size: 1.1rem;
      border-radius: 50%;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all .3s;
      backdrop-filter: blur(4px)
    }

    .topbar-right>button:hover {
      color: var(--text-bright);
      border-color: rgba(234, 246, 238, 0.2);
      background: var(--bg3)
    }

    /* Glass pill nav — stats bar */
    .topbar-stats {
      display: flex;
      align-items: center;
      gap: 0;
      padding: 8px 32px;
      border: 1px solid rgba(63, 226, 138, 0.1);
      border-radius: 9999px;
      background: rgba(12, 18, 16, 0.6);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      box-shadow: 0 0 20px rgba(63, 226, 138, 0.05);
      font-size: .75rem
    }

    .topbar-stats .ts {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 0 20px;
      line-height: 1.3
    }

    .topbar-stats .ts+.ts {
      border-left: 1px solid rgba(234, 246, 238, 0.08)
    }

    .topbar-stats .ts-label {
      color: var(--text-dim);
      letter-spacing: .15em;
      text-transform: uppercase;
      font-size: .6rem
    }

    .topbar-stats .ts-val {
      color: var(--accent);
      font-weight: 700;
      font-size: .9rem
    }

    /* PANELS — glass-panel style */
    .panel {
      border: 1px solid var(--border);
      border-radius: var(--radius-master);
      background: rgba(12, 18, 16, 0.4);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      padding: 32px;
      position: relative;
      box-shadow: var(--shadow-soft)
    }

    .panel-glow {
      border-color: var(--border-hi);
      box-shadow: var(--glow)
    }

    .panel-title {
      font-size: .65rem;
      letter-spacing: .2em;
      text-transform: uppercase;
      color: var(--text-dim);
      margin-bottom: 16px
    }

    .corner-tl,
    .corner-tr,
    .corner-bl,
    .corner-br {
      position: absolute;
      width: 8px;
      height: 8px
    }

    .corner-tl {
      top: -1px;
      left: -1px;
      border-top: 2px solid var(--accent);
      border-left: 2px solid var(--accent)
    }

    .corner-tr {
      top: -1px;
      right: -1px;
      border-top: 2px solid var(--accent);
      border-right: 2px solid var(--accent)
    }

    .corner-bl {
      bottom: -1px;
      left: -1px;
      border-bottom: 2px solid var(--accent);
      border-left: 2px solid var(--accent)
    }

    .corner-br {
      bottom: -1px;
      right: -1px;
      border-bottom: 2px solid var(--accent);
      border-right: 2px solid var(--accent)
    }

    /* BUTTONS */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 24px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text-mid);
      font-family: var(--font);
      font-size: .85rem;
      cursor: pointer;
      border-radius: var(--radius);
      transition: all .3s;
      letter-spacing: .1em;
      text-transform: uppercase;
      font-weight: 500
    }

    .btn:hover {
      background: var(--bg3);
      color: var(--text-bright);
      border-color: rgba(234, 246, 238, 0.2)
    }

    .btn:focus-visible {
      box-shadow: var(--focus-ring);
      outline: none
    }

    .btn-primary {
      background: var(--accent);
      color: var(--bg);
      font-weight: 700;
      border-color: var(--accent);
      box-shadow: 0 0 20px rgba(63, 226, 138, 0.3);
      letter-spacing: .15em
    }

    .btn-primary:hover {
      background: var(--accent-dim);
      box-shadow: 0 0 30px rgba(63, 226, 138, 0.5);
      transform: translateY(-1px)
    }

    .btn-duel {
      border-color: rgba(155, 134, 255, 0.3);
      color: var(--text)
    }

    .btn-duel:hover {
      background: rgba(155, 134, 255, 0.08);
      border-color: var(--duel);
      color: var(--text-bright);
      box-shadow: 0 0 20px var(--duel-glow)
    }

    .btn-info {
      border-color: var(--info);
      color: var(--text)
    }

    .btn-info:hover {
      background: rgba(52, 215, 255, 0.12);
      border-color: var(--info);
      color: var(--text-bright);
      box-shadow: 0 0 6px rgba(52, 215, 255, 0.3)
    }

    .btn-magenta {
      border-color: var(--duel);
      color: var(--text)
    }

    .btn-magenta:hover {
      background: rgba(176, 108, 255, 0.12);
      color: var(--text-bright);
      box-shadow: 0 0 6px rgba(176, 108, 255, 0.3)
    }

    .btn-cyan {
      border-color: var(--info);
      color: var(--text)
    }

    .btn-cyan:hover {
      background: rgba(52, 215, 255, 0.12);
      color: var(--text-bright);
      box-shadow: 0 0 6px rgba(52, 215, 255, 0.3)
    }

    .btn-sm {
      padding: 8px 16px;
      font-size: .8rem
    }

    .btn-ghost {
      border-color: var(--border);
      color: var(--text-dim)
    }

    .btn-ghost:hover {
      border-color: var(--text-mid);
      color: var(--text);
      background: transparent
    }

    /* FORM */
    select,
    input[type="text"],
    input[type="number"] {
      background: var(--bg-input);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 12px 16px;
      font-family: var(--font);
      font-size: .85rem;
      border-radius: var(--radius);
      outline: none;
      transition: all .3s;
      appearance: none;
      -webkit-appearance: none
    }

    select:hover,
    input[type="text"]:hover,
    input[type="number"]:hover {
      border-color: rgba(234, 246, 238, 0.15)
    }

    select:focus,
    input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent);
    }

    select {
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%233FE28A' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
      background-position: right 12px center;
      background-repeat: no-repeat;
      background-size: 1.2em 1.2em;
      padding-right: 36px;
      cursor: pointer
    }

    .toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer
    }

    .toggle-track {
      width: 40px;
      height: 22px;
      border-radius: 11px;
      border: 2px solid var(--border);
      background: var(--bg);
      position: relative;
      transition: .2s
    }

    .toggle-track::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: var(--text-dim);
      transition: .2s
    }

    .toggle.on .toggle-track {
      border-color: var(--accent);
      background: var(--accent-dim)
    }

    .toggle.on .toggle-track::after {
      left: 20px;
      background: var(--accent);
      box-shadow: var(--glow-sm)
    }

    /* LED BIT PANEL */
    .bit-panel {
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: center
    }

    .bit-row {
      display: flex;
      gap: 6px;
      justify-content: center;
      flex-wrap: nowrap
    }

    .bit-cell {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px
    }

    .led {
      width: 48px;
      height: 48px;
      border: 2px solid var(--border);
      border-radius: 4px;
      background: var(--bg);
      cursor: pointer;
      position: relative;
      transition: .15s;
      display: flex;
      align-items: center;
      justify-content: center
    }

    .led::after {
      content: '';
      width: 60%;
      height: 4px;
      background: var(--text-dim);
      border-radius: 2px;
      transition: .15s
    }

    .led.on {
      border-color: var(--accent);
      background: var(--accent);
      box-shadow: var(--glow)
    }

    .led.on::after {
      background: rgba(0, 0, 0, .3)
    }

    .bit-label {
      font-size: .65rem;
      color: var(--text-dim);
      letter-spacing: .05em;
      display: none
    }

    .show-weights .bit-label {
      display: block
    }

    .bit-cell.on .bit-label {
      color: var(--accent);
      font-weight: bold
    }

    .bit-msb-lsb {
      display: flex;
      justify-content: space-between;
      width: 100%;
      font-size: .55rem;
      color: var(--text-dim);
      letter-spacing: .1em;
      margin-top: 4px;
      opacity: .6
    }

    /* DIGITAL */
    .digital {
      font-size: 3.5rem;
      font-weight: bold;
      color: var(--accent);
      text-shadow: 0 0 10px var(--accent), 0 0 30px var(--accent);
      letter-spacing: .08em;
      text-align: center;
      font-family: var(--font)
    }

    .digital-sm {
      font-size: 2rem
    }

    .digital-brackets::before {
      content: '[ ';
      color: var(--text-dim)
    }

    .digital-brackets::after {
      content: ' ]';
      color: var(--text-dim)
    }

    .binary-display {
      font-size: 2.2rem;
      letter-spacing: .3em;
      color: var(--accent);
      text-shadow: 0 0 6px var(--accent);
      text-align: center;
      font-family: var(--font)
    }

    .current-total {
      display: inline-flex;
      align-items: center;
      gap: 12px;
      padding: 10px 24px;
      border: var(--border-w) solid var(--accent);
      border-radius: var(--radius);
      background: var(--bg2);
      margin-top: 16px
    }

    .current-total.over {
      border-color: var(--danger);
      color: var(--danger);
      text-shadow: 0 0 8px var(--danger)
    }

    .current-total.match {
      border-color: var(--accent);
      box-shadow: var(--glow)
    }

    /* FEEDBACK */
    .feedback {
      text-align: center;
      font-size: 1.2rem;
      letter-spacing: .2em;
      min-height: 2em;
      margin-top: 12px
    }

    .feedback.ok {
      color: var(--accent);
      text-shadow: 0 0 10px var(--accent)
    }

    .feedback.err {
      color: var(--danger);
      text-shadow: 0 0 10px var(--danger)
    }

    .feedback.hint {
      color: var(--info)
    }

    /* RESULTS */
    .stat-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 16px;
      margin: 16px 0
    }

    .stat-card {
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      text-align: center;
      background: var(--bg-input);
      transition: border-color .3s
    }

    .stat-card:hover {
      border-color: rgba(63, 226, 138, 0.2)
    }

    .stat-card .stat-label {
      font-size: .6rem;
      letter-spacing: .15em;
      color: var(--text-dim);
      text-transform: uppercase;
      margin-bottom: 6px
    }

    .stat-card .stat-value {
      font-size: 1.6rem;
      font-weight: 700;
      color: var(--text-bright);
      font-family: var(--font)
    }

    /* OVERLAY */
    .overlay {
      position: fixed;
      inset: 0;
      z-index: 100;
      background: rgba(7, 11, 10, .92);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 20px;
      text-align: center;
      padding: 20px
    }

    .overlay .big-text {
      font-size: 2.2rem;
      font-weight: bold;
      color: var(--accent);
      letter-spacing: .15em;
      text-shadow: 0 0 20px var(--accent)
    }

    .overlay .sub-text {
      color: var(--text-dim);
      font-size: 1rem;
      margin-top: 8px
    }

    .overlay .countdown {
      font-size: 5rem;
      color: var(--text-bright);
      text-shadow: 0 0 30px var(--accent)
    }

    /* TUTORIAL */
    .tut-step {
      display: none
    }

    .tut-step.active {
      display: block
    }

    .tut-example {
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 8px 0
    }

    .tut-bits {
      display: flex;
      gap: 4px
    }

    .tut-bit {
      width: 36px;
      height: 36px;
      border: 2px solid var(--border);
      border-radius: 3px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: .9rem
    }

    .tut-bit.on {
      background: var(--accent);
      color: var(--bg);
      border-color: var(--accent);
      box-shadow: var(--glow-sm)
    }

    .tut-bit.off {
      background: var(--bg);
      color: var(--text-dim)
    }

    .tut-bit.clickable {
      cursor: pointer;
      transition: .15s
    }

    .tut-bit.clickable:hover {
      border-color: var(--accent)
    }

    .tut-weight {
      font-size: .55rem;
      color: var(--text-dim);
      text-align: center;
      margin-top: 2px
    }

    .tut-nav {
      display: flex;
      gap: 12px;
      justify-content: center;
      align-items: center;
      margin-top: 20px
    }

    .tut-progress {
      font-size: .75rem;
      color: var(--text-dim);
      letter-spacing: .1em
    }

    .tut-feedback {
      text-align: center;
      margin-top: 8px;
      font-size: 1rem;
      min-height: 1.5em
    }

    /* SETTINGS */
    .settings-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid var(--border)
    }

    .settings-row:last-child {
      border-bottom: none
    }

    .palette-btns {
      display: flex;
      gap: 8px
    }

    .palette-btn {
      width: 32px;
      height: 32px;
      border-radius: 4px;
      border: 2px solid var(--border);
      cursor: pointer;
      transition: .2s
    }

    .palette-btn.active {
      border-color: var(--text-bright);
      box-shadow: 0 0 6px currentColor
    }

    .palette-btn[data-p="green"] {
      background: #25f447
    }

    .palette-btn[data-p="cyan"] {
      background: #0ff
    }

    .palette-btn[data-p="magenta"] {
      background: #f0f
    }

    /* HOME */
    .hero {
      text-align: center;
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 32px;
      max-width: 1100px;
      margin: 0 auto;
      padding: 32px 32px 48px;
      box-sizing: border-box;
      width: 100%
    }

    .hero h2 {
      font-size: clamp(2rem, 5vw, 3.5rem);
      font-weight: 700;
      font-family: var(--font);
      line-height: 1.2;
      letter-spacing: .02em;
      text-align: center;
      background: linear-gradient(180deg, #fff 30%, rgba(234, 246, 238, 0.45));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text
    }

    .hero h2 span {
      background: none;
      -webkit-text-fill-color: var(--accent);
      display: block;
      margin-top: 8px;
      font-weight: 700;
      letter-spacing: .08em;
      text-shadow: 0 0 20px rgba(63, 226, 138, 0.25);
      filter: drop-shadow(0 0 10px rgba(63, 226, 138, 0.15))
    }

    .hero p {
      color: var(--text-dim);
      max-width: 500px;
      line-height: 1.6;
      font-size: .9rem;
      letter-spacing: .1em
    }

    .hero p .accent-word {
      color: var(--accent)
    }

    /* Action card grid (3-col) */
    .hero-buttons {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 24px;
      width: 100%;
      max-width: 900px
    }

    .action-card {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 48px 24px 36px;
      border-radius: var(--radius-master);
      background: var(--bg2);
      border: 1px solid var(--border);
      cursor: pointer;
      font-family: var(--font);
      color: var(--text);
      text-decoration: none;
      overflow: hidden;
      transition: all .4s cubic-bezier(0.25, 0.46, 0.45, 0.94)
    }

    .action-card::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(63, 226, 138, 0.04), transparent);
      opacity: 0;
      transition: opacity .5s
    }

    .action-card:hover {
      transform: translateY(-4px);
      border-color: var(--border-hi);
      box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.7), 0 0 25px rgba(63, 226, 138, 0.1)
    }

    .action-card:hover::before {
      opacity: 1
    }

    .action-card.duel-card::before {
      background: linear-gradient(135deg, rgba(155, 134, 255, 0.04), transparent)
    }

    .action-card.duel-card:hover {
      border-color: rgba(155, 134, 255, 0.5);
      box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.7), 0 0 25px var(--duel-glow)
    }

    .action-card .card-icon {
      width: 64px;
      height: 64px;
      border-radius: 16px;
      background: var(--bg-input);
      border: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 20px;
      font-size: 1.8rem;
      color: var(--accent);
      transition: all .3s;
      position: relative;
      z-index: 1
    }

    .action-card:hover .card-icon {
      border-color: var(--border-hi);
      box-shadow: var(--glow)
    }

    .action-card.duel-card .card-icon {
      background: #110F16;
      color: var(--duel)
    }

    .action-card.duel-card:hover .card-icon {
      border-color: rgba(155, 134, 255, 0.4);
      box-shadow: 0 0 20px var(--duel-glow)
    }

    .action-card .card-title {
      font-size: 1rem;
      font-weight: 700;
      letter-spacing: .12em;
      margin-bottom: 6px;
      position: relative;
      z-index: 1;
      transition: color .3s
    }

    .action-card:hover .card-title {
      color: var(--accent)
    }

    .action-card.duel-card:hover .card-title {
      color: var(--duel)
    }

    .action-card .card-sub {
      font-size: .6rem;
      color: var(--text-dim);
      letter-spacing: .15em;
      text-transform: uppercase;
      font-weight: 500;
      position: relative;
      z-index: 1
    }

    .hero-stat-bar {
      display: flex;
      gap: 12px;
      margin-top: 24px;
      flex-wrap: wrap;
      justify-content: center
    }

    .hero-stat {
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 10px 16px;
      background: var(--bg2);
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 120px
    }

    .hero-stat .hs-label {
      font-size: .6rem;
      color: var(--text-dim);
      letter-spacing: .15em;
      text-transform: uppercase
    }

    .hero-stat .hs-value {
      font-size: 1.2rem;
      font-weight: bold;
      color: var(--accent);
      font-family: var(--font)
    }

    .system-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 16px;
      border: 1px solid rgba(63, 226, 138, 0.2);
      border-radius: 9999px;
      background: rgba(63, 226, 138, 0.05);
      font-size: .6rem;
      color: var(--accent);
      letter-spacing: .2em;
      text-transform: uppercase;
      font-weight: 700;
      box-shadow: 0 0 15px rgba(63, 226, 138, 0.1)
    }

    .system-badge::before {
      content: '';
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--accent);
      animation: badge-pulse 2s infinite;
      box-shadow: 0 0 6px var(--accent)
    }

    @keyframes badge-pulse {

      0%,
      100% {
        opacity: 1;
        transform: scale(1)
      }

      50% {
        opacity: .4;
        transform: scale(0.8)
      }
    }

    /* SETUP/MODE */
    .setup-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin: 20px 0
    }

    .mode-card {
      border: 1px solid var(--border);
      border-radius: var(--radius-master);
      padding: 24px;
      text-align: center;
      cursor: pointer;
      transition: all .3s;
      background: var(--bg-input)
    }

    .mode-card:hover {
      border-color: rgba(234, 246, 238, 0.15);
      background: var(--bg3)
    }

    .mode-card.selected {
      border-color: var(--border-hi);
      box-shadow: var(--glow);
      background: rgba(63, 226, 138, .05)
    }

    .mode-card h3 {
      color: var(--accent);
      font-size: 1rem;
      margin-bottom: 8px;
      letter-spacing: .12em;
      font-weight: 700
    }

    .mode-card p {
      font-size: .7rem;
      color: var(--text-dim)
    }

    /* LEVELS */
    .level-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin: 16px 0
    }

    .level-card {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px 20px;
      border: 1px solid var(--border);
      border-radius: var(--radius-master);
      background: var(--bg-input);
      cursor: pointer;
      transition: all .3s
    }

    .level-card:hover:not(.locked) {
      border-color: rgba(63, 226, 138, 0.2);
      background: var(--bg3)
    }

    .level-card.locked {
      opacity: .35;
      cursor: not-allowed
    }

    .level-card.completed {
      border-color: rgba(63, 226, 138, 0.15)
    }

    .level-num {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--accent);
      min-width: 40px
    }

    .level-info {
      flex: 1
    }

    .level-info .level-name {
      font-size: .9rem;
      color: var(--text-bright);
      font-weight: bold
    }

    .level-info .level-desc {
      font-size: .7rem;
      color: var(--text-dim);
      margin-top: 2px
    }

    .level-info .level-mission {
      font-size: .65rem;
      color: var(--accent2);
      margin-top: 3px;
      font-style: italic
    }

    .level-badge {
      font-size: .75rem;
      color: var(--accent);
      letter-spacing: .1em
    }

    /* GAMEPLAY HUD */
    .game-hud {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      margin-bottom: 16px
    }

    .game-hud-item {
      text-align: center
    }

    .game-hud-label {
      font-size: .6rem;
      color: var(--text-dim);
      letter-spacing: .15em;
      text-transform: uppercase
    }

    .game-hud-value {
      font-size: 1.3rem;
      font-weight: bold;
      color: var(--accent)
    }

    /* DEC INPUT */
    .dec-input-wrap {
      display: flex;
      gap: 8px;
      justify-content: center;
      align-items: center;
      margin-top: 16px
    }

    .dec-input-wrap input {
      width: 160px;
      font-size: 1.6rem;
      text-align: center;
      padding: 12px;
      border: var(--border-w) solid var(--accent);
      background: var(--bg);
      color: var(--accent);
      font-family: var(--font);
      border-radius: var(--radius)
    }

    /* CAMPAIGN PROGRESS MAP */
    .progress-map {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      margin-top: 32px;
      width: 100%;
      max-width: 560px
    }

    .pm-nodes {
      display: flex;
      align-items: center;
      gap: 0;
      width: 100%;
      justify-content: center
    }

    .pm-line {
      flex: 1;
      max-width: 56px;
      height: 2px;
      background: var(--border);
      transition: .3s
    }

    .pm-line.done {
      background: var(--accent-dim)
    }

    .pm-node {
      position: relative;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 1px solid var(--border);
      background: var(--bg2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: .75rem;
      color: var(--text-dim);
      cursor: default;
      transition: all .3s;
      flex-shrink: 0
    }

    .pm-node.unlocked {
      border-color: var(--accent-dim);
      color: var(--text);
      cursor: pointer
    }

    .pm-node.unlocked:hover {
      border-color: var(--accent);
      background: var(--accent-soft)
    }

    .pm-node.unlocked:focus-visible {
      box-shadow: var(--focus-ring);
      outline: none
    }

    .pm-node.current {
      border-color: var(--accent);
      color: var(--accent);
      box-shadow: 0 0 8px var(--accent-glow);
      cursor: pointer
    }

    .pm-node.completed {
      border-color: var(--accent);
      background: var(--accent);
      color: var(--bg);
      cursor: pointer;
      box-shadow: 0 0 15px rgba(63, 226, 138, 0.4);
      border-width: 2px
    }

    .pm-node.locked {
      opacity: .4;
      cursor: not-allowed
    }

    .pm-stars {
      position: absolute;
      bottom: -14px;
      left: 50%;
      transform: translateX(-50%);
      font-size: .6rem;
      letter-spacing: .05em;
      white-space: nowrap;
      color: var(--warning)
    }

    .pm-tooltip {
      display: none;
      position: absolute;
      bottom: calc(100% + 18px);
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg2);
      border: 1px solid rgba(63, 226, 138, 0.2);
      border-radius: var(--radius);
      padding: 8px 12px;
      font-size: .6rem;
      color: var(--accent);
      white-space: nowrap;
      z-index: 20;
      box-shadow: 0 4px 16px rgba(0, 0, 0, .5);
      pointer-events: none;
      text-align: left;
      line-height: 1.6;
      font-weight: 700
    }

    .pm-tooltip::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-top-color: var(--border)
    }

    .pm-node:hover .pm-tooltip,
    .pm-node:focus .pm-tooltip {
      display: block
    }

    .pm-microcopy {
      font-size: .6rem;
      color: var(--text-dim);
      text-align: center;
      margin-top: 12px;
      letter-spacing: .05em;
      line-height: 1.5
    }

    /* Campaign node bar (compact, in campaign screen) */
    .campaign-nodebar {
      display: flex;
      align-items: center;
      gap: 0;
      justify-content: center;
      margin-bottom: 16px
    }

    .cnb-line {
      width: 24px;
      height: 2px;
      background: var(--border)
    }

    .cnb-line.done {
      background: var(--accent-dim)
    }

    .cnb-node {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: 2px solid var(--border);
      background: var(--bg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: .7rem;
      font-weight: bold;
      color: var(--text-dim);
      flex-shrink: 0
    }

    .cnb-node.completed {
      border-color: var(--accent);
      background: var(--accent);
      color: var(--bg)
    }

    .cnb-node.current {
      border-color: var(--accent);
      color: var(--accent)
    }

    .cnb-node.locked {
      opacity: .35
    }

    .cnb-label {
      font-size: .7rem;
      color: var(--text-mid);
      letter-spacing: .1em;
      margin-left: 12px
    }

    /* Star display in results */
    .result-stars {
      font-size: 1.4rem;
      letter-spacing: .15em;
      margin: 8px 0;
      text-align: center
    }

    .star-earned {
      color: var(--warning)
    }

    .star-empty {
      color: var(--text-dim);
      opacity: .3
    }

    /* Training setup */


    .train-setup-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }



    .train-mode-btns {
      display: flex;
      gap: 8px;
      margin: 8px 0 4px
    }

    .train-mode-btns .btn {
      flex: 1;
      font-size: .75rem;
      padding: 8px 4px
    }

    .train-mode-btns .btn.selected {
      background: var(--accent-soft);
      border-color: var(--accent);
      color: var(--text-bright)
    }



    /* Home CTA — uniform size */
    /* Tutorial mini-button */
    /* Home CTA */
    .hero-tutorial-btn {
      margin-top: 16px;
      text-align: center
    }

    /* Training andamento section */
    .tn-section {
      margin-top: 0;
      border-top: none;
      padding-top: 0;
      display: flex;
      flex-direction: column;
      flex: 1
    }

    .tn-section-title {
      font-size: .75rem;
      letter-spacing: .15em;
      color: var(--text-dim);
      text-transform: uppercase;
      margin-bottom: 12px
    }

    .tn-mini-stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-bottom: 20px
    }

    .tn-mini-card {
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px 8px;
      text-align: left;
      transition: border-color .3s
    }

    .tn-mini-card:hover {
      border-color: rgba(63, 226, 138, 0.2)
    }

    .tn-mini-card .tn-val {
      font-size: 1.4rem;
      font-weight: 700;
      color: var(--text-bright);
      font-family: var(--font)
    }

    .tn-mini-card .tn-lbl {
      font-size: .55rem;
      color: var(--text-dim);
      letter-spacing: .1em;
      text-transform: uppercase;
      margin-bottom: 4px
    }

    .tn-sessions-list {
      font-size: .7rem;
      color: var(--text-mid);
      display: grid;
      gap: 4px;
      margin-bottom: 12px
    }

    .tn-session-row {
      display: flex;
      justify-content: space-between;
      padding: 6px 8px;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 8px
    }

    .tn-session-row span {
      white-space: nowrap
    }

    /* Chart container */
    .tn-chart-wrap {
      margin-top: 12px;
      display: flex;
      flex-direction: column;
      flex: 1
    }

    .tn-chart-controls {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-bottom: 8px;
      align-items: center
    }

    .tn-chart-controls .btn {
      font-size: .65rem;
      padding: 4px 10px;
      border-radius: 3px
    }

    .tn-chart-controls .btn.active {
      background: var(--accent-soft);
      border-color: var(--accent);
      color: var(--text-bright)
    }

    .tn-chart-controls .sep {
      width: 1px;
      height: 16px;
      background: var(--border);
      margin: 0 4px
    }

    #training-chart {
      width: 100%;
      flex: 1;
      min-height: 160px;
      border: 1px solid rgba(234, 246, 238, 0.05);
      border-radius: var(--radius);
      background: rgba(15, 22, 19, 0.5);
      position: relative;
      overflow: hidden
    }

    .tn-actions {
      display: flex;
      gap: 8px;
      margin-top: 10px;
      justify-content: flex-end
    }

    .tn-actions .btn {
      font-size: .65rem;
      padding: 4px 10px
    }

    /* RESPONSIVE */
    @media(max-width:600px) {
      .hero h2 {
        font-size: 1.8rem
      }

      .digital {
        font-size: 2.5rem
      }

      .binary-display {
        font-size: 1.4rem;
        letter-spacing: .15em
      }

      .led {
        width: 36px;
        height: 36px
      }

      .setup-grid {
        grid-template-columns: 1fr
      }

      .stat-grid {
        grid-template-columns: 1fr 1fr
      }

      .overlay .big-text {
        font-size: 1.6rem
      }

      .topbar-stats {
        display: none
      }

      .pm-node {
        width: 28px;
        height: 28px;
        font-size: .65rem
      }

      .pm-line {
        max-width: 24px
      }

      .pm-tooltip {
        font-size: .6rem;
        padding: 8px 10px
      }

      .cnb-node {
        width: 22px;
        height: 22px;
        font-size: .6rem
      }

      .cnb-line {
        width: 14px
      }

      .train-setup-grid {
        grid-template-columns: 1fr
      }

      .tn-mini-stats {
        grid-template-columns: repeat(2, 1fr)
      }

      #training-chart {
        height: 130px
      }

      .train-layout {
        flex-direction: column
      }

      .train-col-config,
      .train-col-stats {
        width: 100%
      }

      .hero-buttons {
        grid-template-columns: 1fr;
        max-width: 340px;
        margin: 0 auto;
        gap: 16px
      }

      .action-card {
        padding: 32px 24px 28px
      }

      .hero {
        padding: 24px 20px 32px;
        gap: 24px
      }
    }

    /* ═══ TRAINING — UI aligned to referenze/allenamento ═══ */
    .train-layout {
      display: flex;
      gap: 24px;
      width: 100%;
      max-width: 1280px;
      margin: 0 auto;
      padding: 16px 24px
    }

    .train-col-config {
      width: 33.33%;
      flex-shrink: 0;
      display: flex
    }

    .train-col-stats {
      flex: 1;
      display: flex
    }

    .train-glass {
      background: rgba(11, 20, 17, .6);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      border: 1px solid rgba(62, 234, 146, .1);
      border-radius: var(--radius-master);
      padding: 32px;
      display: flex;
      flex-direction: column;
      width: 100%;
      position: relative;
      overflow: hidden
    }

    .train-glass-glow {
      position: absolute;
      top: 0;
      right: 0;
      width: 128px;
      height: 128px;
      background: rgba(63, 226, 138, .05);
      border-radius: 50%;
      filter: blur(48px);
      pointer-events: none
    }

    .train-sec-hdr {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 32px
    }

    .train-sec-hdr .t-icon {
      color: var(--accent);
      font-size: 1.2rem
    }

    .train-sec-hdr h2 {
      font-size: 1rem;
      font-weight: 700;
      letter-spacing: .15em;
      color: #fff;
      margin: 0;
      background: none;
      -webkit-text-fill-color: #fff
    }

    .train-toggle-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px;
      border-radius: 12px;
      background: var(--bg-input);
      border: 1px solid rgba(234, 246, 238, .05);
      transition: border-color .3s
    }

    .train-toggle-row:hover {
      border-color: rgba(63, 226, 138, .3)
    }

    .train-toggle-row .mode-label {
      font-size: .85rem;
      font-weight: 500
    }

    .train-toggle-row .arrow {
      color: var(--text-dim);
      margin: 0 8px
    }

    .ref-toggle {
      position: relative;
      display: inline-block;
      width: 48px;
      height: 24px
    }

    .ref-toggle input {
      opacity: 0;
      width: 0;
      height: 0;
      position: absolute
    }

    .ref-toggle-track {
      position: absolute;
      cursor: pointer;
      inset: 0;
      background: rgba(234, 246, 238, .15);
      border-radius: 24px;
      transition: background .3s
    }

    .ref-toggle-track::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      left: 2px;
      bottom: 2px;
      background: #fff;
      border-radius: 50%;
      transition: all .3s;
      border: 3px solid rgba(234, 246, 238, .3)
    }

    .ref-toggle input:checked+.ref-toggle-track {
      background: var(--accent)
    }

    .ref-toggle input:checked+.ref-toggle-track::after {
      left: 26px;
      border-color: var(--accent)
    }

    .train-field-lbl {
      font-size: .6rem;
      letter-spacing: .15em;
      color: var(--text-dim);
      text-transform: uppercase;
      font-weight: 700;
      margin-bottom: 8px;
      display: block
    }

    .train-select {
      display: block;
      width: 100%;
      padding: 12px 16px;
      padding-right: 40px;
      font-size: .85rem;
      background: var(--bg-input);
      border: 1px solid rgba(234, 246, 238, .08);
      color: #fff;
      border-radius: 12px;
      font-family: var(--font);
      outline: none;
      cursor: pointer;
      transition: all .3s;
      appearance: none;
      -webkit-appearance: none;
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%233FE28A' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
      background-position: right 8px center;
      background-repeat: no-repeat;
      background-size: 24px 24px
    }

    .train-select:hover {
      border-color: rgba(234, 246, 238, .15)
    }

    .train-select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent)
    }

    .train-cta-ref {
      width: 100%;
      padding: 16px;
      background: var(--accent);
      color: #070B0A;
      font-weight: 700;
      font-size: .85rem;
      letter-spacing: .15em;
      text-transform: uppercase;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      transition: all .3s;
      box-shadow: 0 0 20px rgba(63, 226, 138, .3);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-family: var(--font)
    }

    .train-cta-ref:hover {
      background: #34c97d;
      box-shadow: 0 0 30px rgba(63, 226, 138, .5);
      transform: translateY(-2px)
    }

    .tn-ref-card {
      background: var(--bg-input);
      border: 1px solid rgba(234, 246, 238, .06);
      border-radius: 12px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      transition: border-color .3s
    }

    .tn-ref-card:hover {
      border-color: rgba(63, 226, 138, .2)
    }

    .tn-ref-card .tn-lbl {
      font-size: .6rem;
      letter-spacing: .15em;
      color: var(--text-dim);
      text-transform: uppercase;
      font-weight: 700;
      margin-bottom: 4px
    }

    .tn-ref-card .tn-val {
      font-size: 1.8rem;
      font-weight: 700;
      color: #fff;
      font-family: var(--font);
      transition: color .3s
    }

    .tn-ref-card:hover .tn-val {
      color: var(--accent)
    }

    .tn-ref-card:hover .tn-val.txt-red {
      color: #f87171
    }

    .tn-ref-card:hover .tn-val.txt-purple {
      color: #9B86FF
    }

    .tn-bar {
      height: 4px;
      width: 100%;
      background: rgba(234, 246, 238, .08);
      margin-top: 12px;
      border-radius: 4px;
      overflow: hidden
    }

    .tn-bar-fill {
      height: 100%;
      border-radius: 4px;
      background: var(--accent)
    }

    .tn-bar-fill.red {
      background: #f87171
    }

    .tn-ref-extra {
      display: flex;
      align-items: center;
      gap: 4px;
      margin-top: 8px;
      font-size: .6rem;
      font-weight: 500
    }

    .tn-ref-extra.green {
      color: #4ade80
    }

    .tn-ref-extra.purple {
      color: #9B86FF
    }

    .tn-chart-box {
      flex: 1;
      background: rgba(15, 22, 19, .5);
      border: 1px solid rgba(234, 246, 238, .03);
      border-radius: 12px;
      padding: 24px;
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      min-height: 220px
    }

    .tn-chart-box .ch-hdr {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px
    }

    .tn-chart-box .ch-title {
      font-size: .65rem;
      font-weight: 700;
      color: var(--text-dim);
      letter-spacing: .15em;
      text-transform: uppercase
    }

    .tn-chart-box .ch-live {
      display: flex;
      align-items: center;
      gap: 8px
    }

    .tn-chart-box .ch-live .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--accent);
      animation: badge-pulse 2s infinite
    }

    .tn-chart-box .ch-live span {
      font-size: .6rem;
      color: var(--accent);
      font-weight: 700
    }

    .tn-chart-box .ch-area {
      flex: 1;
      position: relative;
      min-height: 200px
    }

    .tn-chart-box .ch-grid {
      position: absolute;
      inset: 0;
      pointer-events: none;
      background-image: linear-gradient(rgba(234, 246, 238, .03) 1px, transparent 1px), linear-gradient(90deg, rgba(234, 246, 238, .03) 1px, transparent 1px);
      background-size: 40px 40px
    }

    .tn-chart-box .ch-days {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      display: flex;
      justify-content: space-between;
      font-size: .55rem;
      color: var(--text-dim);
      font-family: var(--font);
      padding: 0 16px
    }

    /* ═══ TUTORIAL PILL — UI aligned to referenze/home ═══ */
    .btn-tut-pill {
      display: inline-flex;
      align-items: center;
      gap: 12px;
      padding: 12px 32px;
      border-radius: var(--radius-master);
      border: 1px solid rgba(234, 246, 238, .08);
      color: var(--text-dim);
      background: transparent;
      font-size: .6rem;
      font-weight: 700;
      letter-spacing: .2em;
      text-transform: uppercase;
      cursor: pointer;
      transition: all .3s;
      font-family: var(--font);
      text-decoration: none
    }

    .btn-tut-pill:hover {
      background: var(--bg3);
      color: #fff;
      border-color: rgba(234, 246, 238, .15)
    }

    /* ═══ CAMPAIGN — UI aligned to referenze/campagna ═══ */
    .camp-wrap {
      display: flex;
      flex-direction: column;
      width: 100%;
      max-width: 768px;
      margin: 0 auto;
      height: calc(100vh - 120px);
      overflow: hidden;
      padding: 0 16px;
      position: relative
    }

    .camp-header {
      background: rgba(12, 18, 16, .4);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      border: 1px solid rgba(234, 246, 238, .08);
      box-shadow: 0 0 15px rgba(0, 0, 0, .2);
      border-radius: var(--radius-master);
      padding: 24px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      margin-bottom: 24px;
      flex-shrink: 0
    }

    .camp-header h1 {
      font-size: 1.2rem;
      font-weight: 700;
      letter-spacing: .2em;
      color: #fff;
      text-transform: uppercase;
      text-align: center;
      margin: 0;
      background: none;
      -webkit-text-fill-color: #fff
    }

    .camp-progress {
      display: flex;
      align-items: center;
      position: relative;
      width: 100%;
      max-width: 400px;
      justify-content: center;
      padding: 0 16px
    }

    .camp-progress .cp-bg {
      position: absolute;
      left: 24px;
      right: 24px;
      top: 50%;
      height: 2px;
      background: rgba(234, 246, 238, .08);
      border-radius: 2px;
      z-index: 0
    }

    .camp-progress .cp-done {
      position: absolute;
      left: 24px;
      top: 50%;
      height: 2px;
      background: var(--accent);
      border-radius: 2px;
      z-index: 0;
      box-shadow: 0 0 10px rgba(63, 226, 138, .5)
    }

    .camp-progress .cp-nodes {
      display: flex;
      justify-content: space-between;
      width: 100%;
      position: relative;
      z-index: 1
    }

    .cp-nd {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: .75rem;
      font-weight: 700;
      flex-shrink: 0
    }

    .cp-nd.done {
      background: var(--accent);
      color: #070B0A;
      box-shadow: 0 0 15px rgba(63, 226, 138, .4);
      border: 2px solid #070B0A
    }

    .cp-nd.cur {
      background: var(--bg3);
      border: 1px solid rgba(234, 246, 238, .08);
      color: var(--text-dim)
    }

    .cp-nd.locked {
      background: var(--bg2);
      border: 1px solid rgba(234, 246, 238, .08);
      color: var(--text-dim)
    }

    .camp-levels {
      flex: 1;
      overflow-y: auto;
      padding-right: 8px;
      margin-right: -8px;
      display: flex;
      flex-direction: column;
      gap: 24px;
      padding-bottom: 80px
    }

    .camp-levels::-webkit-scrollbar {
      width: 6px
    }

    .camp-levels::-webkit-scrollbar-track {
      background: rgba(12, 18, 16, .4);
      border-radius: 10px
    }

    .camp-levels::-webkit-scrollbar-thumb {
      background: rgba(63, 226, 138, .2);
      border-radius: 10px
    }

    .camp-levels::-webkit-scrollbar-thumb:hover {
      background: rgba(63, 226, 138, .4)
    }

    .clv-card {
      position: relative;
      border-radius: var(--radius-master);
      padding: 24px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 24px;
      transition: all .3s
    }

    .clv-card.unlocked {
      background: var(--bg2);
      border: 1px solid rgba(63, 226, 138, .3);
      box-shadow: 0 0 20px rgba(63, 226, 138, .05)
    }

    .clv-card.unlocked:hover {
      background: var(--bg3)
    }

    .clv-card.unlocked .clv-grad {
      position: absolute;
      inset: 0;
      background: linear-gradient(to right, rgba(63, 226, 138, .05), transparent);
      border-radius: var(--radius-master);
      pointer-events: none
    }

    .clv-card.locked-card {
      background: rgba(12, 18, 16, .4);
      border: 1px solid rgba(234, 246, 238, .05);
      opacity: .6;
      transition: opacity .3s
    }

    .clv-card.locked-card:hover {
      opacity: .8
    }

    .clv-left {
      display: flex;
      align-items: center;
      gap: 24px;
      z-index: 1;
      flex: 1;
      min-width: 200px
    }

    .clv-icon {
      width: 64px;
      height: 64px;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.8rem;
      flex-shrink: 0
    }

    .clv-card.unlocked .clv-icon {
      background: var(--bg-input);
      border: 1px solid rgba(63, 226, 138, .4);
      box-shadow: var(--glow);
      color: var(--accent)
    }

    .clv-card.locked-card .clv-icon {
      background: var(--bg2);
      border: 1px solid rgba(234, 246, 238, .08);
      color: var(--text-dim)
    }

    .clv-info .clv-tag {
      font-size: .65rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: .15em;
      padding: 2px 8px;
      border-radius: 4px;
      display: inline-block;
      margin-bottom: 4px
    }

    .clv-card.unlocked .clv-tag {
      color: var(--accent);
      border: 1px solid rgba(63, 226, 138, .2);
      background: rgba(63, 226, 138, .1)
    }

    .clv-card.locked-card .clv-tag {
      color: var(--text-dim);
      border: 1px solid rgba(234, 246, 238, .08)
    }

    .clv-info .clv-name {
      font-size: 1.4rem;
      font-weight: 700;
      letter-spacing: .08em;
      margin: 0
    }

    .clv-card.unlocked .clv-name {
      color: #fff
    }

    .clv-card.locked-card .clv-name {
      color: var(--text-mid)
    }

    .clv-info .clv-desc {
      font-size: .7rem;
      margin-top: 4px
    }

    .clv-card.unlocked .clv-desc {
      color: var(--text-dim)
    }

    .clv-card.locked-card .clv-desc {
      color: var(--text-dim)
    }

    .clv-right {
      display: flex;
      align-items: center;
      gap: 32px;
      z-index: 1;
      flex-wrap: wrap
    }

    .clv-metrics {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 24px;
      text-align: left
    }

    .clv-metrics .cm-lbl {
      font-size: .6rem;
      text-transform: uppercase;
      letter-spacing: .1em;
      margin-bottom: 4px
    }

    .clv-card.unlocked .cm-lbl {
      color: var(--text-dim)
    }

    .clv-card.locked-card .cm-lbl {
      color: var(--text-dim)
    }

    .clv-metrics .cm-val {
      font-size: .85rem;
      font-weight: 700;
      font-family: var(--font)
    }

    .clv-card.unlocked .cm-val {
      color: #fff
    }

    .clv-card.locked-card .cm-val {
      color: var(--text-dim)
    }

    .clv-play {
      background: var(--accent);
      color: #070B0A;
      font-weight: 700;
      padding: 12px 32px;
      border-radius: 9999px;
      border: none;
      cursor: pointer;
      transition: all .3s;
      box-shadow: 0 0 15px rgba(63, 226, 138, .4);
      text-transform: uppercase;
      letter-spacing: .12em;
      font-size: .85rem;
      display: flex;
      align-items: center;
      gap: 8px;
      font-family: var(--font)
    }

    .clv-play:hover {
      background: #5affad;
      box-shadow: 0 0 25px rgba(63, 226, 138, .6)
    }

    .clv-locked-badge {
      width: 128px;
      padding: 12px 0;
      text-align: center;
      border: 1px solid rgba(234, 246, 238, .08);
      border-radius: 9999px;
      font-size: .7rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: .12em;
      color: var(--text-dim);
      cursor: not-allowed
    }

    .camp-back {
      position: absolute;
      bottom: 24px;
      left: 0;
      right: 0;
      display: flex;
      justify-content: center;
      z-index: 20;
      pointer-events: none
    }

    .camp-back a {
      pointer-events: auto;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 24px;
      border-radius: 9999px;
      border: 1px solid rgba(234, 246, 238, .08);
      background: rgba(12, 18, 16, .9);
      backdrop-filter: blur(8px);
      color: var(--text-dim);
      font-size: .6rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: .15em;
      cursor: pointer;
      transition: all .3s;
      box-shadow: 0 4px 16px rgba(0, 0, 0, .5);
      text-decoration: none;
      font-family: var(--font)
    }

    .camp-back a:hover {
      background: var(--bg3);
      color: #fff;
      border-color: rgba(234, 246, 238, .15)
    }

    @media(max-width:900px) {
      .train-layout {
        flex-direction: column
      }

      .train-col-config,
      .train-col-stats {
        width: 100%
      }
    }
  </style>
</head>

<body>

  <div class="app">

    <!-- TOPBAR: Impostazioni + compact stats (Change 4) -->
    <header class="topbar">
      <div class="logo" onclick="showScreen('home')">BIN<span>RUSH</span></div>
      <div class="topbar-right">
        <div class="topbar-stats" id="topbar-stats">
          <div class="ts"><span class="ts-label">Sessioni</span><span class="ts-val" id="ts-sessions">0</span></div>
          <div class="ts"><span class="ts-label">Precisione</span><span class="ts-val" id="ts-accuracy">--%</span></div>
          <div class="ts"><span class="ts-label">Tempo Medio</span><span class="ts-val" id="ts-avgtime">--</span></div>
        </div>
        <button onclick="showScreen('settings')" title="Impostazioni">⚙</button>
      </div>
    </header>

    <!-- 1. HOME -->
    <section id="screen-home" class="screen active">
      <div class="hero">
        <div class="system-badge">Sistema Pronto</div>
        <h2>Vuoi Parlare<br>alle Macchine?<br><span>PARTI DAI BIT</span></h2>
        <div class="hero-buttons">
          <div class="action-card" onclick="showScreen('training-setup')">
            <div class="card-icon">▶</div>
            <div class="card-title">ALLENAMENTO</div>
            <div class="card-sub">Pratica Libera</div>
          </div>
          <div class="action-card" onclick="showScreen('campagna')">
            <div class="card-icon">⊞</div>
            <div class="card-title">CAMPAGNA</div>
            <div class="card-sub">Livelli Progressivi</div>
          </div>
          <div class="action-card duel-card" onclick="showScreen('duel-setup')">
            <div class="card-icon">⚔</div>
            <div class="card-title">DUELLO</div>
            <div class="card-sub">Sfida Locale</div>
          </div>
        </div>
        <!-- UI aligned to referenze/home -->
        <div class="hero-tutorial-btn">
          <a class="btn-tut-pill" onclick="showScreen('tutorial')">📖 Tutorial</a>
        </div>
        <!-- Campaign Progress Map -->
        <div id="home-progress-map" class="progress-map"></div>
      </div>
    </section>

    <!-- 2. SETTINGS -->
    <section id="screen-settings" class="screen">
      <div class="panel" style="max-width:500px;margin:auto;">
        <div class="corner-tl"></div>
        <div class="corner-tr"></div>
        <div class="corner-bl"></div>
        <div class="corner-br"></div>
        <h2 style="color:var(--accent);letter-spacing:.15em;margin-bottom:20px;">IMPOSTAZIONI_</h2>

        <div class="settings-row"><span>Audio Effetti</span>
          <div id="toggle-audio" class="toggle" onclick="toggleSetting('audio')">
            <div class="toggle-track"></div>
          </div>
        </div>
        <div class="settings-row"><span>Tema Colore</span>
          <div class="palette-btns">
            <div class="palette-btn" data-p="green" onclick="setPalette('green')"></div>
            <div class="palette-btn" data-p="cyan" onclick="setPalette('cyan')"></div>
            <div class="palette-btn" data-p="magenta" onclick="setPalette('magenta')"></div>
          </div>
        </div>
        <div style="border-top:1px solid var(--border);margin-top:24px;padding-top:16px;text-align:center;">
          <button class="btn btn-sm" style="border-color:var(--danger);color:var(--danger);" onclick="resetAllData()">⚠
            Resetta
            Tutto</button>
        </div>
        <div style="text-align:center;margin-top:16px;"><button class="btn btn-sm" onclick="showScreen('home')">← Torna
            al Menu</button></div>
      </div>
    </section>

    <!-- TRAINING SETUP — UI aligned to referenze/allenamento -->
    <section id="screen-training-setup" class="screen" style="position:relative;">
      <div class="train-layout">
        <!-- Left: CONFIGURAZIONE -->
        <div class="train-col-config">
          <div class="train-glass">
            <div class="train-glass-glow"></div>
            <div class="train-sec-hdr">
              <span class="t-icon">⚙</span>
              <h2>CONFIGURAZIONE</h2>
            </div>
            <div style="display:flex;flex-direction:column;gap:32px;flex:1;">
              <div>
                <label class="train-field-lbl">Modalità di conversione</label>
                <div style="display:flex;flex-direction:column;gap:8px;">
                  <div class="train-toggle-row">
                    <span class="mode-label">Decimale <span class="arrow">→</span> Binario</span>
                    <label class="ref-toggle">
                      <input type="checkbox" id="train-d2b" checked
                        onchange="if(this.checked)document.getElementById('train-b2d').checked=false;else if(!document.getElementById('train-b2d').checked)this.checked=true;">
                      <span class="ref-toggle-track"></span>
                    </label>
                  </div>
                  <div class="train-toggle-row">
                    <span class="mode-label">Binario <span class="arrow">→</span> Decimale</span>
                    <label class="ref-toggle">
                      <input type="checkbox" id="train-b2d"
                        onchange="if(this.checked)document.getElementById('train-d2b').checked=false;else if(!document.getElementById('train-d2b').checked)this.checked=true;">
                      <span class="ref-toggle-track"></span>
                    </label>
                  </div>
                </div>
              </div>
              <div style="display:flex;flex-direction:column;gap:24px;">
                <div>
                  <label class="train-field-lbl">Bit Depth</label>
                  <select id="train-bits" class="train-select">
                    <option value="4" selected>4-bit (Nibble)</option>
                    <option value="8">8-bit (Byte)</option>
                    <option value="16">16-bit (Word)</option>
                  </select>
                </div>
                <div>
                  <label class="train-field-lbl">Rounds</label>
                  <select id="train-rounds" class="train-select">
                    <option value="10">10 Questions</option>
                    <option value="20" selected>20 Questions</option>
                    <option value="50">50 Questions</option>
                  </select>
                </div>
              </div>
            </div>
            <div style="margin-top:32px;padding-top:24px;border-top:1px solid rgba(234,246,238,.08);">
              <button class="train-cta-ref" onclick="startTraining()">▶ Start Allenamento</button>
            </div>
          </div>
        </div>
        <!-- Right: ANDAMENTO -->
        <div class="train-col-stats">
          <div class="train-glass">
            <div class="train-sec-hdr">
              <span class="t-icon">📊</span>
              <h2>ANDAMENTO</h2>
            </div>
            <div class="tn-mini-stats" id="tn-stats-cards" style="grid-template-columns:repeat(2,1fr) repeat(2,1fr);">
            </div>
            <div class="tn-chart-box">
              <div class="ch-hdr">
                <span class="ch-title">Storico Precisione</span>
                <div style="display:flex;align-items:center;gap:16px;">
                  <div style="display:flex;align-items:center;gap:12px;font-size:.55rem;color:var(--text-dim);">
                    <span style="display:inline-flex;align-items:center;gap:4px;"><span
                        style="width:10px;height:2px;background:var(--accent);display:inline-block;border-radius:1px;"></span>Precisione
                      (%)</span>
                    <span style="display:inline-flex;align-items:center;gap:4px;"><span
                        style="width:10px;height:2px;background:#9B86FF;display:inline-block;border-radius:1px;"></span>Tempo
                      medio (s)</span>
                  </div>
                  <button onclick="resetTrainingHistory()" title="Azzera statistiche"
                    aria-label="Azzera statistiche di allenamento"
                    style="background:none;border:1px solid rgba(234,246,238,.08);border-radius:6px;color:var(--text-dim);font-size:.5rem;padding:3px 8px;cursor:pointer;font-family:var(--font);transition:all .3s;letter-spacing:.1em;"
                    onmouseover="this.style.borderColor='rgba(248,113,113,.5)';this.style.color='#f87171'"
                    onmouseout="this.style.borderColor='rgba(234,246,238,.08)';this.style.color='var(--text-dim)'">↺
                    Reset</button>
                  <div class="ch-live"><span class="dot"></span><span>LIVE</span></div>
                </div>
              </div>
              <div class="ch-area">
                <div class="ch-grid"></div>
                <canvas id="training-chart" style="width:100%;height:100%;position:absolute;inset:0;"></canvas>
                <div class="ch-days">
                  <span>LUN</span><span>MAR</span><span>MER</span><span>GIO</span><span>VEN</span><span>SAB</span><span>DOM</span><span>OGGI</span>
                </div>
              </div>
            </div>
            <div id="tn-sessions-list" style="display:none;"></div>
          </div>
        </div>
      </div>
      <!-- Menu button identical to Campagna -->
      <div class="camp-back">
        <a onclick="showScreen('home')">← Torna al Menu</a>
      </div>
    </section>

    <!-- 3. TUTORIAL (Change 1: independent, exits to HOME not campagna) -->
    <section id="screen-tutorial" class="screen">
      <div class="panel" style="max-width:620px;margin:auto;">
        <div class="corner-tl"></div>
        <div class="corner-tr"></div>
        <div class="corner-bl"></div>
        <div class="corner-br"></div>
        <h2 style="color:var(--accent);letter-spacing:.15em;margin-bottom:8px;">TUTORIAL: BINARIO_101</h2>
        <div class="tut-progress" id="tut-progress">Passo 1/6</div>
        <div class="tut-step active" data-step="1">
          <p style="margin:16px 0;font-size:1.05rem;">Un <b style="color:var(--accent)">bit</b> è come una
            <b>lampadina</b>:
          </p>
          <div style="display:flex;gap:24px;justify-content:center;margin:20px 0;">
            <div style="text-align:center;">
              <div class="tut-bit off" style="width:56px;height:56px;font-size:1.3rem;">0</div>
              <div style="font-size:.75rem;color:var(--text-dim);margin-top:6px;">Spenta</div>
            </div>
            <div style="text-align:center;">
              <div class="tut-bit on" style="width:56px;height:56px;font-size:1.3rem;">1</div>
              <div style="font-size:.75rem;color:var(--accent);margin-top:6px;">Accesa</div>
            </div>
          </div>
          <p style="color:var(--text-dim);font-size:.9rem;">Può essere solo 0 oppure 1. Semplice!</p>
        </div>
        <div class="tut-step" data-step="2">
          <p style="margin:16px 0;font-size:1.05rem;">Ogni lampadina vale il <b style="color:var(--accent)">doppio</b>
            della precedente (da destra):</p>
          <div style="display:flex;gap:8px;justify-content:center;margin:20px 0;">
            <div style="text-align:center;">
              <div class="tut-bit off" style="width:48px;height:48px;">0</div>
              <div class="tut-weight">8</div>
            </div>
            <div style="text-align:center;">
              <div class="tut-bit off" style="width:48px;height:48px;">0</div>
              <div class="tut-weight">4</div>
            </div>
            <div style="text-align:center;">
              <div class="tut-bit off" style="width:48px;height:48px;">0</div>
              <div class="tut-weight">2</div>
            </div>
            <div style="text-align:center;">
              <div class="tut-bit off" style="width:48px;height:48px;">0</div>
              <div class="tut-weight">1</div>
            </div>
          </div>
          <p style="color:var(--text-dim);font-size:.9rem;">La prima vale <b>1</b>, poi <b>2</b>, poi <b>4</b>, poi
            <b>8</b>… sempre il doppio!
          </p>
        </div>
        <div class="tut-step" data-step="3">
          <p style="margin:16px 0;font-size:1.05rem;">🎯 Prova! Accendi le lampadine per ottenere <b
              style="color:var(--accent);font-size:1.3rem;">5</b></p>
          <div id="tut-ex1-bits" style="display:flex;gap:8px;justify-content:center;margin:20px 0;"></div>
          <div id="tut-ex1-feedback" class="tut-feedback"></div>
          <p style="color:var(--text-dim);font-size:.75rem;text-align:center;">Clicca sulle lampadine per accenderle
            (4+1=5)</p>
        </div>
        <div class="tut-step" data-step="4">
          <p style="margin:16px 0;font-size:1.05rem;">Per tornare al <b style="color:var(--accent)">decimale</b>, sommi
            i valori delle lampadine <b>accese</b>:</p>
          <div class="tut-example" style="justify-content:center;">
            <div class="tut-bits">
              <div class="tut-bit off">0</div>
              <div class="tut-bit on">1</div>
              <div class="tut-bit on">1</div>
              <div class="tut-bit off">0</div>
            </div>
          </div>
          <div style="text-align:center;margin:12px 0;">
            <div style="display:flex;gap:4px;justify-content:center;font-size:.7rem;color:var(--text-dim);"><span
                style="width:36px;">8</span><span style="width:36px;">4</span><span style="width:36px;">2</span><span
                style="width:36px;">1</span></div>
            <p style="margin-top:8px;color:var(--accent);font-size:1.1rem;">0 + <b>4</b> + <b>2</b> + 0 = <b>6</b></p>
          </div>
        </div>
        <div class="tut-step" data-step="5">
          <p style="margin:16px 0;font-size:1.05rem;">🎯 Che numero è questo?</p>
          <div style="display:flex;gap:8px;justify-content:center;margin:16px 0;">
            <div style="text-align:center;">
              <div class="tut-bit off" style="width:48px;height:48px;">0</div>
              <div class="tut-weight">8</div>
            </div>
            <div style="text-align:center;">
              <div class="tut-bit on" style="width:48px;height:48px;">1</div>
              <div class="tut-weight">4</div>
            </div>
            <div style="text-align:center;">
              <div class="tut-bit off" style="width:48px;height:48px;">0</div>
              <div class="tut-weight">2</div>
            </div>
            <div style="text-align:center;">
              <div class="tut-bit on" style="width:48px;height:48px;">1</div>
              <div class="tut-weight">1</div>
            </div>
          </div>
          <div class="dec-input-wrap"><input type="number" id="tut-ex2-input" placeholder="?"
              style="width:100px;font-size:1.3rem;"><button class="btn btn-sm" onclick="checkTutEx2()">Invio</button>
          </div>
          <div id="tut-ex2-feedback" class="tut-feedback"></div>
        </div>
        <div class="tut-step" data-step="6">
          <p style="margin:16px 0;font-size:1.1rem;text-align:center;">🎉 <b style="color:var(--accent)">Bravo!</b> Ora
            sai come funziona il binario!</p>
          <p style="color:var(--text-dim);font-size:.9rem;text-align:center;margin-bottom:16px;">Mettiti alla prova con
            la Campagna. Si parte da 4 bit facili!</p>
          <div style="text-align:center;"><button class="btn btn-primary" onclick="startCampaignLevel(1)">Prova Adesso →
              Livello 1</button></div>
        </div>
        <div class="tut-nav">
          <button class="btn btn-ghost btn-sm" id="tut-btn-prev" onclick="tutStep(-1)" style="visibility:hidden;">←
            Indietro</button>
          <span class="tut-progress" id="tut-progress2"></span>
          <button class="btn btn-sm" id="tut-btn-next" onclick="tutStep(1)">Avanti →</button>
          <button class="btn btn-ghost btn-sm" onclick="showScreen('home')">Esci</button>
        </div>
      </div>
    </section>

    <!-- 4. CAMPAGNA — UI aligned to referenze/campagna -->
    <section id="screen-campagna" class="screen">
      <div class="camp-wrap">
        <div class="camp-header">
          <h1>Campagna</h1>
          <div id="campaign-nodebar" class="camp-progress"></div>
        </div>
        <div id="level-list" class="camp-levels"></div>
        <div class="camp-back">
          <a onclick="showScreen('home')">← Torna al Menu</a>
        </div>
      </div>
    </section>

    <!-- 5. GAMEPLAY -->
    <section id="screen-train-play" class="screen">
      <div class="game-hud">
        <div class="game-hud-item">
          <div class="game-hud-label">Round</div>
          <div id="hud-round" class="game-hud-value">1/10</div>
        </div>
        <div class="game-hud-item">
          <div class="game-hud-label">Streak</div>
          <div id="hud-streak" class="game-hud-value">0</div>
        </div>
        <div class="game-hud-item">
          <div class="game-hud-label">Tempo</div>
          <div id="hud-time" class="game-hud-value">0.0s</div>
        </div>
        <div class="game-hud-item">
          <div class="game-hud-label">Errori</div>
          <div id="hud-errors" class="game-hud-value">0</div>
        </div>
      </div>
      <!-- Campaign-only HUD row: max errors + target avg time -->
      <div id="campaign-hud" style="display:none;text-align:center;margin-bottom:12px;">
        <span style="font-size:.75rem;color:var(--text-dim);letter-spacing:.1em;">Max Errori: <b id="hud-max-errors"
            style="color:var(--accent);">3</b></span>
        <span style="margin:0 12px;color:var(--border);">|</span>
        <span style="font-size:.75rem;color:var(--text-dim);letter-spacing:.1em;">Target Tempo Medio: <b
            id="hud-max-avgtime" style="color:var(--accent);">≤ 4.0s</b></span>
      </div>
      <div style="text-align:center;margin-bottom:16px;">
        <div class="panel-title" id="target-label">OBIETTIVO DECIMALE</div>
        <div id="target-display" class="digital digital-brackets">0</div>
      </div>
      <div id="bit-panel-area" class="panel" style="padding:20px;">
        <div id="bit-panel" class="bit-panel"></div>
        <div class="bit-msb-lsb"><span>MSB</span><span>LSB</span></div>
      </div>
      <div id="total-area" style="text-align:center;">
        <div class="current-total"><span style="font-size:.7rem;letter-spacing:.1em;color:var(--text-dim);">TOTALE
            ATTUALE:</span><span id="current-total-val" class="digital-sm"
            style="font-size:1.5rem;color:var(--accent);">0</span></div>
      </div>
      <div id="dec-input-area" style="display:none;text-align:center;">
        <div class="dec-input-wrap"><input type="number" id="dec-answer" placeholder="?" autocomplete="off"><button
            class="btn btn-sm" onclick="submitDecAnswer()">Invio</button></div>
        <button id="hint-btn" class="btn btn-ghost btn-sm" style="margin-top:12px;" onclick="showHint()">💡
          Suggerimento</button>
        <div id="hint-area" style="margin-top:8px;color:var(--accent2);font-size:.85rem;"></div>
      </div>
      <div id="game-feedback" class="feedback"></div>
      <div style="text-align:center;margin-top:12px;display:flex;gap:8px;justify-content:center;">
        <button class="btn btn-ghost btn-sm" id="btn-reset-bits" onclick="resetBits()">↺ Reset Bit</button>
        <button class="btn btn-ghost btn-sm" onclick="abortGame()">✕ Esci</button>
      </div>
    </section>

    <!-- 6. RESULTS -->
    <section id="screen-results" class="screen">
      <div class="panel" style="max-width:600px;margin:auto;">
        <div class="corner-tl"></div>
        <div class="corner-tr"></div>
        <div class="corner-bl"></div>
        <div class="corner-br"></div>
        <h2 id="results-title" style="color:var(--accent);letter-spacing:.15em;margin-bottom:8px;">SESSIONE COMPLETATA
        </h2>
        <div id="results-subtitle" style="color:var(--text-dim);font-size:.8rem;margin-bottom:16px;"></div>
        <div id="results-stats" class="stat-grid"></div>
        <div id="results-extra" style="margin:12px 0;text-align:center;font-size:.85rem;"></div>
        <div id="results-buttons"
          style="text-align:center;margin-top:20px;display:flex;gap:12px;justify-content:center;flex-wrap:wrap;">
          <button id="btn-replay" class="btn btn-primary" onclick="replayGame()">↻ Rigioca</button>
          <button id="btn-next-level" class="btn" onclick="goNextLevel()" style="display:none;">Livello Successivo
            →</button>
          <button class="btn btn-ghost" onclick="showScreen('home')">⌂ Torna al Menu</button>
        </div>
      </div>
    </section>

    <!-- 7. DUEL SETUP -->
    <section id="screen-duel-setup" class="screen">
      <div class="panel" style="max-width:620px;margin:auto;">
        <div class="corner-tl"></div>
        <div class="corner-tr"></div>
        <div class="corner-bl"></div>
        <div class="corner-br"></div>
        <h2 style="color:var(--duel);letter-spacing:.15em;margin-bottom:8px;">DUELLO //</h2>
        <p class="panel-title">Configurazione partita a turni</p>
        <div class="setup-grid">
          <div><label class="panel-title">Giocatore 1</label><input type="text" id="duel-p1" value="Giocatore 1"
              maxlength="16" style="width:100%"></div>
          <div><label class="panel-title">Giocatore 2</label><input type="text" id="duel-p2" value="Giocatore 2"
              maxlength="16" style="width:100%"></div>
        </div>
        <div class="setup-grid">
          <div id="duel-mode-d2b" class="mode-card selected" onclick="selectDuelMode('dec2bin')">
            <h3>DEC → BIN</h3>
          </div>
          <div id="duel-mode-b2d" class="mode-card" onclick="selectDuelMode('bin2dec')">
            <h3>BIN → DEC</h3>
          </div>
        </div>
        <div class="setup-grid">
          <div><label class="panel-title">Bit</label><select id="duel-bits">
              <option value="4" selected>4 bit</option>
              <option value="6">6 bit</option>
              <option value="8">8 bit</option>
              <option value="12">12 bit</option>
              <option value="16">16 bit</option>
            </select></div>
          <div><label class="panel-title">Round</label><select id="duel-rounds">
              <option value="5" selected>5</option>
              <option value="10">10</option>
              <option value="15">15</option>
              <option value="20">20</option>
              <option value="25">25</option>
              <option value="30">30</option>
            </select></div>
        </div>
        <div style="text-align:center;margin-top:20px;display:flex;gap:12px;justify-content:center;">
          <button class="btn btn-primary" style="border-color:var(--duel);background:var(--duel);"
            onclick="startDuel()">⚔ Inizia Duello</button>
          <button class="btn btn-ghost btn-sm" onclick="showScreen('home')">← Menu</button>
        </div>
      </div>
    </section>

    <!-- DUEL OVERLAY -->
    <div id="duel-overlay" class="overlay" style="display:none;">
      <div id="duel-overlay-text" class="big-text"></div>
      <div id="duel-overlay-sub" class="sub-text"></div>
      <div id="duel-overlay-countdown" class="countdown"></div>
      <button id="duel-overlay-btn" class="btn btn-primary" style="display:none;" onclick="duelOverlayConfirm()">Inizia
        Turno</button>
    </div>

  </div><!-- end .app -->
  <script>
    /* ═══ BINRUSH — Full Game Logic ═══ */

    // ── SEEDED RNG ──
    function SeededRNG(seed) { this.s = seed % 2147483647; if (this.s <= 0) this.s += 2147483646 }
    SeededRNG.prototype.next = function () { this.s = this.s * 16807 % 2147483647; return (this.s - 1) / 2147483646 };
    SeededRNG.prototype.nextInt = function (min, max) { return Math.floor(this.next() * (max - min + 1)) + min };

    // ── STORAGE ──
    const STORAGE_KEY = 'binrush_v1';
    let store = loadStore();
    function loadStore() {
      try { const d = JSON.parse(localStorage.getItem(STORAGE_KEY)); if (d && d.schemaVersion === 1) return d; } catch (e) { }
      return { schemaVersion: 1, settings: { palette: 'green', scanlines: false, audio: true }, records: {}, campaign: { currentLevel: 1, completed: [], starsByLevel: {}, bestStatsByLevel: {} }, stats: { sessions: 0, totalCorrect: 0, totalRounds: 0, bestAvgTime: null } };
    }
    function saveStore() { try { localStorage.setItem(STORAGE_KEY, JSON.stringify(store)); } catch (e) { } }
    function updateRecord(mode, bits, acc, avgTime) {
      const k = mode + '_' + bits; if (!store.records[k]) store.records[k] = {};
      const r = store.records[k];
      if (!r.bestAccuracy || acc > r.bestAccuracy) r.bestAccuracy = acc;
      if (!r.bestAvgTime || avgTime < r.bestAvgTime) r.bestAvgTime = avgTime;
      saveStore();
    }
    function trackSession(correct, total, avgTime) {
      if (!store.stats) store.stats = { sessions: 0, totalCorrect: 0, totalRounds: 0, bestAvgTime: null };
      store.stats.sessions++;
      store.stats.totalCorrect += correct;
      store.stats.totalRounds += total;
      if (avgTime > 0 && (!store.stats.bestAvgTime || avgTime < store.stats.bestAvgTime)) store.stats.bestAvgTime = avgTime;
      saveStore();
    }

    // ── AUDIO ──
    let audioCtx = null;
    function ensureAudio() { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)() }
    function beep(freq, dur, type) {
      if (!store.settings.audio) return; try {
        ensureAudio();
        const o = audioCtx.createOscillator(), g = audioCtx.createGain();
        o.type = type || 'square'; o.frequency.value = freq;
        g.gain.setValueAtTime(0.08, audioCtx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + dur);
        o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime + dur);
      } catch (e) { }
    }
    function beepOk() { beep(880, .12, 'square'); setTimeout(() => beep(1320, .15, 'square'), 80) }
    function beepErr() { beep(220, .25, 'sawtooth') }

    // ── ROUTER ──
    let currentScreen = 'home';
    function showScreen(id) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      const el = document.getElementById('screen-' + id);
      if (el) { el.classList.add('active'); currentScreen = id }
      if (id === 'home') { renderProgressMap(); updateTopbarStats() }
      if (id === 'campagna') { renderCampaignNodeBar(); renderCampaignLevels() }
      if (id === 'tutorial') initTutorial();
      if (id === 'training-setup') renderTrainingStats();
    }

    // ── SETTINGS ──
    function applySettings() {
      const s = store.settings;
      document.documentElement.removeAttribute('data-palette');
      if (s.palette !== 'green') document.documentElement.setAttribute('data-palette', s.palette);
      const at = document.getElementById('toggle-audio'); if (at) at.classList.toggle('on', s.audio);
      document.querySelectorAll('.palette-btn').forEach(b => b.classList.toggle('active', b.dataset.p === s.palette));
    }
    function toggleSetting(key) { store.settings[key] = !store.settings[key]; saveStore(); applySettings() }
    function setPalette(p) { store.settings.palette = p; saveStore(); applySettings() }
    function resetAllData() {
      if (!confirm('Sei sicuro? Tutti i progressi, record e statistiche verranno cancellati.')) return;
      localStorage.removeItem(STORAGE_KEY); location.reload();
    }

    function updateHomeStats() { renderProgressMap() }
    function updateTopbarStats() {
      const s = store.stats || { sessions: 0, totalCorrect: 0, totalRounds: 0, bestAvgTime: null };
      document.getElementById('ts-sessions').textContent = s.sessions || 0;
      const acc = s.totalRounds > 0 ? Math.round((s.totalCorrect / s.totalRounds) * 100) + '%' : '0%';
      document.getElementById('ts-accuracy').textContent = acc;
      document.getElementById('ts-avgtime').textContent = s.bestAvgTime != null ? (s.bestAvgTime / 1000).toFixed(1) + 's' : '0.0s';
    }

    // ═══ CAMPAIGN ═══
    const LEVELS = [
      {
        id: 1, name: 'Livello 1 — Nibble', desc: '4 bit, aiuti attivi, 6 round misti',
        mission: 'Max errori: 3 | Tempo medio ≤ 4.0s',
        bits: 4, rounds: 6, aiuti: true, maxErrors: 3, maxAvgTime: 4000, d2bRatio: .6,
        silverTime: 3000, goldTime: 2200
      },
      {
        id: 2, name: 'Livello 2 — Espansione', desc: '6 bit, aiuti attivi, 6 round misti',
        mission: 'Max errori: 3 | Tempo medio ≤ 3.2s',
        bits: 6, rounds: 6, aiuti: true, maxErrors: 3, maxAvgTime: 3200, d2bRatio: .5,
        silverTime: 2500, goldTime: 1800
      },
      {
        id: 3, name: 'Livello 3 — Byte', desc: '8 bit, aiuti attivi, 10 round misti',
        mission: 'Max errori: 2 | Tempo medio ≤ 2.7s',
        bits: 8, rounds: 10, aiuti: true, maxErrors: 2, maxAvgTime: 2700, d2bRatio: .5,
        silverTime: 2200, goldTime: 1500
      },
      {
        id: 4, name: 'Livello 4 — Doppio', desc: '12 bit, senza aiuti, 10 round misti',
        mission: 'Max errori: 2 | Tempo medio ≤ 2.2s',
        bits: 12, rounds: 10, aiuti: false, maxErrors: 2, maxAvgTime: 2200, d2bRatio: .5,
        silverTime: 1800, goldTime: 1300
      },
      {
        id: 5, name: 'Livello 5 — Maestro', desc: '16 bit, senza aiuti, 10 round misti',
        mission: 'Max errori: 1 | Tempo medio ≤ 1.9s',
        bits: 16, rounds: 10, aiuti: false, maxErrors: 1, maxAvgTime: 1900, d2bRatio: .5,
        silverTime: 1500, goldTime: 1100
      }
    ];

    // ── STAR COMPUTATION ──
    function computeStars(lv, errors, avgTime) {
      // Must pass base criteria
      if (errors > lv.maxErrors || avgTime > lv.maxAvgTime) return 0;
      // 3 stars: gold time OR zero errors
      if (avgTime <= lv.goldTime || errors === 0) return 3;
      // 2 stars: silver time
      if (avgTime <= lv.silverTime) return 2;
      return 1;
    }
    function starsHTML(n, size) {
      const s = size || '';
      let h = '';
      for (let i = 0; i < 3; i++) h += '<span class="' + (i < n ? 'star-earned' : 'star-empty') + '"' + (s ? ' style="font-size:' + s + '"' : '') + '>★</span>';
      return h;
    }

    // ── PROGRESS MAP (HOME) ──
    function renderProgressMap() {
      const el = document.getElementById('home-progress-map');
      if (!el) return;
      const cur = store.campaign.currentLevel || 1;
      const comp = store.campaign.completed || [];
      const stars = store.campaign.starsByLevel || {};
      const bests = store.campaign.bestStatsByLevel || {};
      let html = '<div class="pm-nodes">';
      LEVELS.forEach((lv, i) => {
        if (i > 0) {
          const lineDone = comp.includes(LEVELS[i - 1].id);
          html += '<div class="pm-line' + (lineDone ? ' done' : '') + '"></div>';
        }
        const done = comp.includes(lv.id);
        const unlocked = lv.id <= cur;
        const isCurrent = lv.id === cur && !done;
        let cls = 'pm-node';
        if (done) cls += ' completed unlocked';
        else if (isCurrent) cls += ' current unlocked';
        else if (unlocked) cls += ' unlocked';
        else cls += ' locked';
        const st = stars[lv.id] || 0;
        const best = bests[lv.id];
        // Tooltip content
        let tip = '<b>' + lv.name + '</b><br>';
        tip += 'Max errori: ' + lv.maxErrors + ' · Tempo ≤ ' + (lv.maxAvgTime / 1000).toFixed(1) + 's<br>';
        tip += '★★ ≤ ' + (lv.silverTime / 1000).toFixed(1) + 's · ★★★ ≤ ' + (lv.goldTime / 1000).toFixed(1) + 's o 0 errori';
        if (best) {
          tip += '<br>──<br>';
          tip += 'Best: ' + (best.bestAvgTime / 1000).toFixed(1) + 's · Errori: ' + best.bestErrors;
        }
        const tabIdx = unlocked ? ' tabindex="0" role="button" aria-label="Livello ' + lv.id + '"' : '';
        html += '<div class="' + cls + '"' + tabIdx;
        if (unlocked) html += ' onclick="startCampaignLevel(' + lv.id + ')"';
        html += '>';
        html += lv.id;
        if (done && st > 0) html += '<div class="pm-stars">' + starsHTML(st, '.55rem') + '</div>';
        if (unlocked) html += '<div class="pm-tooltip">' + tip + '</div>';
        html += '</div>';
      });
      html += '</div>';
      html += '<div class="pm-microcopy">Completa i livelli e guadagna ★ migliorando tempo medio ed errori.</div>';
      el.innerHTML = html;
    }

    // ── CAMPAIGN NODE BAR (CAMPAIGN SCREEN) ──
    /* UI aligned to referenze/campagna */
    function renderCampaignNodeBar() {
      const el = document.getElementById('campaign-nodebar');
      if (!el) return;
      const cur = store.campaign.currentLevel || 1;
      const comp = store.campaign.completed || [];
      const doneCount = comp.length;
      const pct = doneCount > 0 ? Math.max(5, (doneCount / LEVELS.length) * 100) : 0;
      let nodes = '';
      LEVELS.forEach(lv => {
        const done = comp.includes(lv.id);
        let cls = 'cp-nd';
        if (done) cls += ' done';
        else if (lv.id === cur) cls += ' cur';
        else cls += ' locked';
        nodes += '<div class="' + cls + '">' + lv.id + '</div>';
      });
      el.innerHTML = '<div class="cp-bg"></div>' +
        '<div class="cp-done" style="right:' + (100 - pct) + '%"></div>' +
        '<div class="cp-nodes">' + nodes + '</div>';
    }

    function renderCampaignLevels() {
      const list = document.getElementById('level-list'); if (!list) return;
      list.innerHTML = '';
      const cur = store.campaign.currentLevel || 1;
      const comp = store.campaign.completed || [];
      const stars = store.campaign.starsByLevel || {};
      const shortNames = { 1: 'NIBBLE', 2: 'ESPANSIONE', 3: 'BYTE', 4: 'DOPPIO', 5: 'MAESTRO' };
      LEVELS.forEach(lv => {
        const unlocked = lv.id <= cur, done = comp.includes(lv.id);
        const st = stars[lv.id] || 0;
        const isActive = unlocked;
        const card = document.createElement('div');
        card.className = 'clv-card ' + (isActive ? 'unlocked' : 'locked-card');
        const icon = isActive ? '🧠' : '🔒';
        const shortName = shortNames[lv.id] || lv.name;
        const starStr = done && st > 0 ? ' ' + starsHTML(st, '.75rem') : '';
        const bitLabel = lv.bits + '-bit';
        const targetLabel = (lv.maxAvgTime / 1000).toFixed(0) + 's';
        let actionHTML;
        if (isActive) {
          actionHTML = '<button class="clv-play" onclick="startCampaignLevel(' + lv.id + ')">▶ Gioca</button>';
        } else {
          actionHTML = '<div class="clv-locked-badge">Bloccato</div>';
        }
        card.innerHTML =
          (isActive ? '<div class="clv-grad"></div>' : '') +
          '<div class="clv-left">' +
          '<div class="clv-icon">' + icon + '</div>' +
          '<div class="clv-info">' +
          '<span class="clv-tag">Livello ' + lv.id + starStr + '</span>' +
          '<h2 class="clv-name">' + shortName + '</h2>' +
          '<p class="clv-desc">' + lv.desc + '</p>' +
          '</div>' +
          '</div>' +
          '<div class="clv-right">' +
          '<div class="clv-metrics">' +
          '<div><div class="cm-lbl">Bit Depth</div><div class="cm-val">' + bitLabel + '</div></div>' +
          '<div><div class="cm-lbl">Errori Max</div><div class="cm-val">' + lv.maxErrors + '</div></div>' +
          '<div><div class="cm-lbl">Target</div><div class="cm-val">' + targetLabel + '</div></div>' +
          '</div>' +
          actionHTML +
          '</div>';
        if (isActive && !card.querySelector('.clv-play')) card.onclick = () => startCampaignLevel(lv.id);
        list.appendChild(card);
      });
    }

    // Generate mixed-mode targets: array of {value, mode} objects
    function genMixedTargets(bits, count, d2bRatio) {
      const max = (1 << bits) - 1; const targets = []; let prev = -1;
      const d2bCount = Math.round(count * d2bRatio);
      // Build mode array: first d2bCount are dec2bin, rest bin2dec, then shuffle
      const modes = [];
      for (let i = 0; i < d2bCount; i++)modes.push('dec2bin');
      for (let i = d2bCount; i < count; i++)modes.push('bin2dec');
      // Fisher-Yates shuffle
      for (let i = modes.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1));[modes[i], modes[j]] = [modes[j], modes[i]] }
      for (let i = 0; i < count; i++) {
        let v; do { v = Math.floor(Math.random() * max) + 1 } while (v === prev && max > 1);
        targets.push({ value: v, mode: modes[i] }); prev = v;
      }
      return targets;
    }

    function startCampaignLevel(lvId) {
      const lv = LEVELS.find(l => l.id === lvId); if (!lv) return;
      const mixed = genMixedTargets(lv.bits, lv.rounds, lv.d2bRatio);
      game = {
        type: 'campaign', campaignLevel: lvId, mode: 'mixed', bits: lv.bits,
        rounds: lv.rounds, aiuti: lv.aiuti, round: 0, errors: 0, streak: 0,
        maxStreak: 0, hintsUsed: 0, times: [],
        mixedTargets: mixed,  // array of {value, mode}
        bitState: [], roundDone: false, currentTarget: 0, currentMode: 'dec2bin',
        roundStart: 0, timerInterval: null,
        maxErrors: lv.maxErrors, maxAvgTime: lv.maxAvgTime
      };
      window._lastGame = { type: 'campaign', campaignLevel: lvId };
      showScreen('train-play');
      // Show campaign HUD with thresholds
      const cHud = document.getElementById('campaign-hud');
      cHud.style.display = '';
      document.getElementById('hud-max-errors').textContent = lv.maxErrors;
      document.getElementById('hud-max-avgtime').textContent = '≤ ' + (lv.maxAvgTime / 1000).toFixed(1) + 's';
      nextRound();
    }

    function goNextLevel() {
      if (!game || game.type !== 'campaign') return;
      const nextLv = game.campaignLevel + 1;
      if (nextLv <= 5) startCampaignLevel(nextLv); else showScreen('campagna');
    }

    // ═══ TUTORIAL ═══
    let tutCurrentStep = 1; const TUT_TOTAL = 6;
    function initTutorial() { tutCurrentStep = 1; updateTutStep(); initTutEx1() }
    function updateTutStep() {
      document.querySelectorAll('.tut-step').forEach(s => s.classList.toggle('active', parseInt(s.dataset.step) === tutCurrentStep));
      document.getElementById('tut-progress').textContent = 'Passo ' + tutCurrentStep + '/' + TUT_TOTAL;
      document.getElementById('tut-progress2').textContent = tutCurrentStep + '/' + TUT_TOTAL;
      document.getElementById('tut-btn-prev').style.visibility = tutCurrentStep > 1 ? 'visible' : 'hidden';
      document.getElementById('tut-btn-next').style.display = tutCurrentStep < TUT_TOTAL ? '' : 'none';
    }
    function tutStep(dir) { tutCurrentStep = Math.max(1, Math.min(TUT_TOTAL, tutCurrentStep + dir)); updateTutStep(); if (tutCurrentStep === 3) initTutEx1(); if (tutCurrentStep === TUT_TOTAL) markTutorialCompleted() }
    function initTutEx1() {
      const area = document.getElementById('tut-ex1-bits'); if (!area) return; area.innerHTML = '';
      window._tutEx1 = [0, 0, 0, 0]; const weights = [8, 4, 2, 1];
      for (let i = 0; i < 4; i++) {
        const wrap = document.createElement('div'); wrap.style.textAlign = 'center';
        const bit = document.createElement('div');
        bit.className = 'tut-bit off clickable'; bit.style.cssText = 'width:48px;height:48px';
        bit.textContent = '0'; bit.dataset.idx = i;
        bit.onclick = function () {
          window._tutEx1[i] = window._tutEx1[i] ? 0 : 1;
          bit.textContent = window._tutEx1[i] ? '1' : '0';
          bit.className = 'tut-bit clickable ' + (window._tutEx1[i] ? 'on' : 'off');
          bit.style.cssText = 'width:48px;height:48px'; checkTutEx1();
        };
        const w = document.createElement('div'); w.className = 'tut-weight'; w.textContent = weights[i];
        wrap.appendChild(bit); wrap.appendChild(w); area.appendChild(wrap);
      }
      document.getElementById('tut-ex1-feedback').textContent = '';
    }
    function checkTutEx1() {
      const sum = window._tutEx1[0] * 8 + window._tutEx1[1] * 4 + window._tutEx1[2] * 2 + window._tutEx1[3] * 1;
      const fb = document.getElementById('tut-ex1-feedback');
      if (sum === 5) { fb.textContent = '✓ Perfetto! 4+1 = 5'; fb.style.color = 'var(--accent)'; beepOk() }
      else { fb.textContent = 'Totale attuale: ' + sum; fb.style.color = 'var(--text-dim)' }
    }
    function checkTutEx2() {
      const val = parseInt(document.getElementById('tut-ex2-input').value);
      const fb = document.getElementById('tut-ex2-feedback');
      if (val === 5) { fb.textContent = '✓ Esatto! 0101 = 4+1 = 5'; fb.style.color = 'var(--accent)'; beepOk() }
      else { fb.textContent = 'Riprova! Somma le lampadine accese.'; fb.style.color = '#ff4444'; beepErr() }
    }

    // ═══ GAME STATE ═══
    let game = null;
    function selectDuelMode(m) {
      document.getElementById('duel-mode-d2b').classList.toggle('selected', m === 'dec2bin');
      document.getElementById('duel-mode-b2d').classList.toggle('selected', m === 'bin2dec');
    }
    function genTargetsNoSeed(bits, count) {
      const max = (1 << bits) - 1; const targets = []; let prev = -1;
      for (let i = 0; i < count; i++) { let v; do { v = Math.floor(Math.random() * max) + 1 } while (v === prev && max > 1); targets.push(v); prev = v }
      return targets;
    }

    // ═══ BIT PANEL ═══
    function renderBitPanel(bits, showWeights) {
      const panel = document.getElementById('bit-panel'); panel.innerHTML = '';
      game.bitState = new Array(bits).fill(0);
      document.getElementById('bit-panel-area').classList.toggle('show-weights', !!showWeights);
      if (bits <= 8) {
        const row = document.createElement('div'); row.className = 'bit-row';
        for (let i = 0; i < bits; i++)row.appendChild(makeBitCell(i, bits)); panel.appendChild(row);
      } else {
        const row1 = document.createElement('div'); row1.className = 'bit-row';
        for (let i = 0; i < 8; i++)row1.appendChild(makeBitCell(i, bits)); panel.appendChild(row1);
        const row2 = document.createElement('div'); row2.className = 'bit-row';
        for (let i = 8; i < bits; i++)row2.appendChild(makeBitCell(i, bits)); panel.appendChild(row2);
      }
    }
    function makeBitCell(index, totalBits) {
      const cell = document.createElement('div'); cell.className = 'bit-cell'; cell.dataset.idx = index;
      const power = totalBits - 1 - index;
      const led = document.createElement('div'); led.className = 'led'; led.dataset.idx = index;
      led.onclick = function () { toggleBit(index) };
      const label = document.createElement('div'); label.className = 'bit-label'; label.textContent = (1 << power);
      cell.appendChild(led); cell.appendChild(label); return cell;
    }
    function toggleBit(idx) { if (!game || game.roundDone) return; game.bitState[idx] = game.bitState[idx] ? 0 : 1; updateBitUI(); checkDec2Bin() }
    function resetBits() { if (!game) return; game.bitState.fill(0); updateBitUI(); updateCurrentTotal(); document.getElementById('game-feedback').textContent = ''; document.getElementById('game-feedback').className = 'feedback' }
    function updateBitUI() {
      document.getElementById('bit-panel').querySelectorAll('.bit-cell').forEach(cell => {
        const idx = parseInt(cell.dataset.idx); const on = game.bitState[idx] === 1;
        cell.classList.toggle('on', on); cell.querySelector('.led').classList.toggle('on', on);
      }); updateCurrentTotal();
    }
    function getCurrentTotal() { if (!game) return 0; let sum = 0; for (let i = 0; i < game.bitState.length; i++) { if (game.bitState[i]) sum += (1 << (game.bitState.length - 1 - i)) } return sum }
    function updateCurrentTotal() {
      const t = getCurrentTotal(); const el = document.getElementById('current-total-val'); if (el) el.textContent = t;
      const wrap = el ? el.closest('.current-total') : null; if (!wrap || !game) return;
      wrap.classList.remove('over', 'match');
      if (game.currentTarget != null) { if (t > game.currentTarget) wrap.classList.add('over'); else if (t === game.currentTarget) wrap.classList.add('match') }
    }

    // ═══ GAMEPLAY CHECKS ═══
    function checkDec2Bin() {
      if (!game || game.roundDone) return; const t = getCurrentTotal(); const fb = document.getElementById('game-feedback');
      if (t === game.currentTarget) {
        game.roundDone = true; game.streak++; game.maxStreak = Math.max(game.maxStreak, game.streak);
        game.times.push(Date.now() - game.roundStart);
        fb.textContent = '★ PERFETTO! ★'; fb.className = 'feedback ok'; beepOk(); setTimeout(() => nextRound(), 800);
      } else if (t > game.currentTarget) {
        game.errors++; game.streak = 0; fb.textContent = 'Troppo alto!'; fb.className = 'feedback err';
        document.getElementById('hud-errors').textContent = game.errors; beepErr();
        // Hard-fail: campaign mode, errors exceed threshold
        if (game.type === 'campaign' && game.errors > game.maxErrors) { setTimeout(() => campaignHardFail(), 600); return; }
      } else {
        fb.className = 'feedback';
        if (game.aiuti) { fb.textContent = 'Mancano ' + (game.currentTarget - t); fb.className = 'feedback hint' } else { fb.textContent = '' }
      }
    }
    function submitDecAnswer() {
      if (!game || game.roundDone) return; const inp = document.getElementById('dec-answer');
      const val = parseInt(inp.value); const fb = document.getElementById('game-feedback');
      if (isNaN(val)) { fb.textContent = 'Inserisci un numero!'; fb.className = 'feedback err'; return }
      if (val === game.currentTarget) {
        game.roundDone = true; game.streak++; game.maxStreak = Math.max(game.maxStreak, game.streak);
        game.times.push(Date.now() - game.roundStart);
        fb.textContent = '★ PERFETTO! ★'; fb.className = 'feedback ok'; beepOk(); setTimeout(() => nextRound(), 800);
      } else {
        game.errors++; game.streak = 0; document.getElementById('hud-errors').textContent = game.errors; beepErr();
        if (game.aiuti) { const diff = val - game.currentTarget; fb.textContent = diff > 0 ? 'Sei sopra di ' + diff : 'Sei sotto di ' + Math.abs(diff); fb.className = 'feedback hint' }
        else { fb.textContent = 'Sbagliato, riprova!'; fb.className = 'feedback err' }
        // Hard-fail: campaign mode, errors exceed threshold
        if (game.type === 'campaign' && game.errors > game.maxErrors) { setTimeout(() => campaignHardFail(), 600); return; }
      }
    }
    function showHint() {
      if (!game) return; game.hintsUsed++;
      let parts = []; for (let i = game.bits - 1; i >= 0; i--) { if (game.currentTarget & (1 << i)) parts.push((1 << i)) }
      document.getElementById('hint-area').textContent = parts.join(' + ') + ' = ' + game.currentTarget;
    }

    // ═══ PLAY UI (supports mixed mode per-round switching) ═══
    function setupRoundUI(isDec2Bin) {
      document.getElementById('bit-panel-area').style.display = isDec2Bin ? '' : 'none';
      document.getElementById('total-area').style.display = isDec2Bin ? '' : 'none';
      document.getElementById('dec-input-area').style.display = isDec2Bin ? 'none' : '';
      document.getElementById('btn-reset-bits').style.display = isDec2Bin ? '' : 'none';
      document.getElementById('target-label').textContent = isDec2Bin ? 'OBIETTIVO DECIMALE' : 'DATO BINARIO IN INGRESSO';
      const showW = (game.type === 'campaign' && game.campaignLevel <= 2) || (game.type === 'training' && game.aiuti);
      if (isDec2Bin) renderBitPanel(game.bits, showW);
      const hb = document.getElementById('hint-btn');
      if (hb) hb.style.display = (game.aiuti && !isDec2Bin) ? '' : 'none';
    }

    function nextRound() {
      if (game.round >= game.rounds) { endGame(); return }
      // Hide campaign HUD for non-campaign games
      document.getElementById('campaign-hud').style.display = (game.type === 'campaign') ? '' : 'none';

      // Determine mode+target for this round
      let roundMode, roundTarget;
      if (game.mode === 'mixed' && game.mixedTargets) {
        const mt = game.mixedTargets[game.round];
        roundTarget = mt.value; roundMode = mt.mode;
      } else {
        roundTarget = game.targets ? game.targets[game.round] : 0;
        roundMode = game.mode || 'dec2bin';
      }
      game.currentTarget = roundTarget;
      game.currentMode = roundMode;
      game.round++; game.roundDone = false;

      // Update HUD
      document.getElementById('hud-round').textContent = game.round + '/' + game.rounds;
      document.getElementById('hud-streak').textContent = game.streak;
      document.getElementById('hud-errors').textContent = game.errors;
      document.getElementById('game-feedback').textContent = ''; document.getElementById('game-feedback').className = 'feedback';

      // Setup UI for this round's mode
      setupRoundUI(roundMode === 'dec2bin');

      if (roundMode === 'dec2bin') {
        document.getElementById('target-display').textContent = game.currentTarget;
        document.getElementById('target-display').className = 'digital digital-brackets';
        game.bitState.fill(0); updateBitUI();
      } else {
        const binStr = game.currentTarget.toString(2).padStart(game.bits, '0');
        document.getElementById('target-display').textContent = binStr.split('').join(' ');
        document.getElementById('target-display').className = 'binary-display';
        document.getElementById('dec-answer').value = ''; document.getElementById('dec-answer').focus();
        document.getElementById('hint-area').textContent = '';
      }
      game.roundStart = Date.now(); clearInterval(game.timerInterval);
      if (game.timerOn !== false) {
        game.timerInterval = setInterval(() => { document.getElementById('hud-time').textContent = ((Date.now() - game.roundStart) / 1000).toFixed(1) + 's' }, 100);
      } else {
        document.getElementById('hud-time').textContent = '--';
      }
    }

    document.addEventListener('keydown', function (e) {
      if (e.key === 'Enter' && currentScreen === 'train-play' && game && (game.currentMode === 'bin2dec' || game.mode === 'bin2dec') && !game.roundDone) submitDecAnswer();
      if (e.key === 'Enter' && document.getElementById('duel-overlay').style.display === 'flex') {
        const btn = document.getElementById('duel-overlay-btn'); if (btn && btn.style.display !== 'none') duelOverlayConfirm();
      }
    });
    function abortGame() { clearInterval(game?.timerInterval); const t = game?.type; game = null; document.getElementById('campaign-hud').style.display = 'none'; showScreen(t === 'training' ? 'training-setup' : 'home') }

    // Campaign hard-fail: too many errors → immediate stop
    function campaignHardFail() {
      clearInterval(game?.timerInterval);
      const lv = LEVELS.find(l => l.id === game.campaignLevel);
      const correct = game.times.length;
      const avgTime = correct > 0 ? Math.round(game.times.reduce((a, b) => a + b, 0) / correct) : 0;
      trackSession(correct, game.round, avgTime);
      document.getElementById('campaign-hud').style.display = 'none';
      showScreen('results');
      document.getElementById('results-title').textContent = '✕ LIVELLO FALLITO';
      document.getElementById('results-subtitle').textContent = lv.name + ' | ' + game.bits + ' bit | Misto Dec↔Bin';
      document.getElementById('results-extra').innerHTML = '<span style="color:var(--danger);">Troppi errori! (' + game.errors + '/' + lv.maxErrors + ' max)</span>';
      document.getElementById('btn-next-level').style.display = 'none';
      document.getElementById('results-stats').innerHTML = `
    <div class="stat-card"><div class="stat-label">Round Completati</div><div class="stat-value">${game.round}/${game.rounds}</div></div>
    <div class="stat-card"><div class="stat-label">Errori</div><div class="stat-value" style="color:var(--danger)">${game.errors} / ${lv.maxErrors} max</div></div>
    <div class="stat-card"><div class="stat-label">Tempo Medio</div><div class="stat-value">${correct > 0 ? (avgTime / 1000).toFixed(1) + 's' : '--'}</div></div>
    <div class="stat-card"><div class="stat-label">Streak Max</div><div class="stat-value">${game.maxStreak}</div></div>`;
      window._lastGame = { type: 'campaign', campaignLevel: game.campaignLevel };
      updateTopbarStats();
    }

    // ═══ END GAME ═══
    function endGame() {
      clearInterval(game?.timerInterval);
      document.getElementById('campaign-hud').style.display = 'none';
      if (game && game.type === 'duel') { endDuelPlayerRound(); return }
      const correct = game.times.length;
      const acc = Math.round((correct / game.rounds) * 100);
      const avgTime = correct > 0 ? Math.round(game.times.reduce((a, b) => a + b, 0) / correct) : 0;
      // Track cumulative stats
      if (game.type === 'training' && !game.timerOn) {
        // Timer OFF: track sessions + accuracy only, NOT time
        if (!store.stats) store.stats = { sessions: 0, totalCorrect: 0, totalRounds: 0, bestAvgTime: null };
        store.stats.sessions++;
        store.stats.totalCorrect += correct;
        store.stats.totalRounds += game.rounds;
        saveStore();
      } else {
        trackSession(correct, game.rounds, avgTime);
      }
      updateRecord(game.currentMode || game.mode, game.bits, acc, avgTime);
      showScreen('results');

      const nextLvBtn = document.getElementById('btn-next-level');
      if (game.type === 'campaign') {
        const lv = LEVELS.find(l => l.id === game.campaignLevel);
        const lvId = game.campaignLevel;
        // Check pass conditions: max errors + max avg time
        let passed = game.errors <= lv.maxErrors;
        let failReason = '';
        if (!passed) {
          failReason = 'Troppi errori: ' + game.errors + ' (max ' + lv.maxErrors + ')';
        }
        if (passed && avgTime > lv.maxAvgTime) {
          passed = false;
          failReason = 'Tempo medio troppo alto: ' + (avgTime / 1000).toFixed(1) + 's (max ' + (lv.maxAvgTime / 1000).toFixed(1) + 's)';
        }
        // Compute and save stars + best stats
        const earnedStars = passed ? computeStars(lv, game.errors, avgTime) : 0;
        if (passed) {
          if (!store.campaign.completed.includes(lvId)) store.campaign.completed.push(lvId);
          if (lvId >= store.campaign.currentLevel && lvId < 5) store.campaign.currentLevel = lvId + 1;
          const prev = store.campaign.starsByLevel[lvId] || 0;
          if (earnedStars > prev) store.campaign.starsByLevel[lvId] = earnedStars;
          const pb = store.campaign.bestStatsByLevel[lvId];
          if (!pb || avgTime < pb.bestAvgTime) {
            store.campaign.bestStatsByLevel[lvId] = { bestAvgTime: avgTime, bestErrors: game.errors };
          } else if (avgTime === pb.bestAvgTime && game.errors < pb.bestErrors) {
            pb.bestErrors = game.errors;
          }
          saveStore();
          document.getElementById('results-title').textContent = 'LIVELLO SUPERATO ✅';
          const nextLv = lvId < 5 ? lvId + 1 : null;
          document.getElementById('results-extra').innerHTML =
            '<div class="result-stars">' + starsHTML(earnedStars, '1.4rem') + '</div>'
            + '<div style="margin:8px 0;font-size:.9rem;"><span style="color:var(--accent);">Errori: ' + game.errors + '/' + lv.maxErrors + ' max</span> · <span style="color:var(--accent);">Tempo medio: ' + (avgTime / 1000).toFixed(1) + 's / ' + (lv.maxAvgTime / 1000).toFixed(1) + 's max</span></div>'
            + (nextLv ? '<span style="color:var(--accent);font-size:1rem;">🔓 Sbloccato Livello ' + nextLv + '!</span>' : '<span style="color:var(--accent);font-size:1rem;">🏆 Campagna completata!</span>');
          nextLvBtn.style.display = nextLv ? '' : 'none';
        } else {
          document.getElementById('results-title').textContent = '✕ LIVELLO FALLITO';
          document.getElementById('results-extra').innerHTML = '<span style="color:var(--danger);">' + failReason + '</span>';
          nextLvBtn.style.display = 'none';
        }
        document.getElementById('results-subtitle').textContent = lv.name + ' | ' + game.bits + ' bit | Misto Dec↔Bin';
      } else if (game.type === 'training') {
        // Save training session to history
        saveTrainingSession(correct, game.rounds, game.errors, acc, avgTime, game);
        document.getElementById('results-title').textContent = 'ALLENAMENTO COMPLETATO';
        const modeLabel = game.mode === 'dec2bin' ? 'Dec→Bin' : 'Bin→Dec';
        document.getElementById('results-subtitle').textContent = modeLabel + ' | ' + game.bits + ' bit | ' + game.rounds + ' round' + (game.timerOn ? '' : ' | Timer OFF');
        document.getElementById('results-extra').textContent = '';
        nextLvBtn.style.display = 'none';
        // Render results menu idempotently to avoid duplicated action buttons across sessions.
        const oldSetup = document.getElementById('btn-train-setup');
        if (oldSetup) oldSetup.remove();
        const btnSetup = document.createElement('button');
        btnSetup.id = 'btn-train-setup';
        btnSetup.className = 'btn btn-ghost';
        btnSetup.textContent = '⚙ Cambia impostazioni';
        btnSetup.onclick = () => showScreen('training-setup');
        document.getElementById('results-buttons').appendChild(btnSetup);
      } else {
        document.getElementById('results-title').textContent = 'SESSIONE COMPLETATA';
        document.getElementById('results-subtitle').textContent = (game.mode === 'dec2bin' ? 'Dec→Bin' : 'Bin→Dec') + ' | ' + game.bits + ' bit | ' + game.rounds + ' round';
        document.getElementById('results-extra').textContent = '';
        nextLvBtn.style.display = 'none';
      }
      document.getElementById('results-stats').innerHTML = `
    <div class="stat-card"><div class="stat-label">Accuratezza</div><div class="stat-value">${acc}%</div></div>
    <div class="stat-card"><div class="stat-label">Tempo Medio</div><div class="stat-value">${game.timerOn !== false ? (avgTime / 1000).toFixed(1) + 's' : '--'}</div></div>
    <div class="stat-card"><div class="stat-label">Errori</div><div class="stat-value">${game.errors}</div></div>
    <div class="stat-card"><div class="stat-label">Streak Max</div><div class="stat-value">${game.maxStreak}</div></div>
    <div class="stat-card"><div class="stat-label">Aiuti Usati</div><div class="stat-value">${game.hintsUsed}</div></div>`;
      window._lastGame = { type: game.type, mode: game.mode, bits: game.bits, rounds: game.rounds, aiuti: game.aiuti, campaignLevel: game.campaignLevel, timerOn: game.timerOn };
      updateTopbarStats();
    }
    function replayGame() {
      const lg = window._lastGame; if (!lg) { showScreen('home'); return }
      if (lg.type === 'campaign') { startCampaignLevel(lg.campaignLevel) }
      else if (lg.type === 'training') { startTraining() }
      else if (lg.type === 'duel') { startDuel() }
      else { showScreen('home') }
    }

    // ═══ DUEL MODE ═══
    let duel = null;
    function startDuel() {
      const modeD2B = document.getElementById('duel-mode-d2b').classList.contains('selected');
      const mode = modeD2B ? 'dec2bin' : 'bin2dec';
      const bits = parseInt(document.getElementById('duel-bits').value);
      const rounds = parseInt(document.getElementById('duel-rounds').value);
      const p1 = document.getElementById('duel-p1').value.trim() || 'Giocatore 1';
      const p2 = document.getElementById('duel-p2').value.trim() || 'Giocatore 2';
      // Independent random targets for each player
      const targetsP1 = genTargetsNoSeed(bits, rounds);
      const targetsP2 = genTargetsNoSeed(bits, rounds);
      duel = { mode, bits, rounds, players: [p1, p2], targetsP1, targetsP2, results: [null, null], currentPlayer: 0 };
      window._lastGame = { type: 'duel' };
      showDuelOverlay(0, 'turn');
    }
    function showDuelOverlay(playerIdx, phase) {
      const ov = document.getElementById('duel-overlay');
      const txt = document.getElementById('duel-overlay-text');
      const sub = document.getElementById('duel-overlay-sub');
      const cd = document.getElementById('duel-overlay-countdown');
      const btn = document.getElementById('duel-overlay-btn');
      ov.style.display = 'flex';
      if (phase === 'intermission') {
        txt.textContent = 'PASSA IL COMPUTER A ' + duel.players[1].toUpperCase();
        sub.textContent = 'Quando sei pronto, premi il pulsante.'; cd.textContent = ''; btn.style.display = ''; btn.textContent = 'Inizia Turno';
        window._duelOverlayAction = function () { btn.style.display = 'none'; sub.textContent = ''; startReadyCountdown(playerIdx) };
      } else {
        txt.textContent = 'TOCCA A: ' + duel.players[playerIdx].toUpperCase();
        sub.textContent = ''; cd.textContent = ''; btn.style.display = 'none'; startReadyCountdown(playerIdx);
      }
    }
    function startReadyCountdown(playerIdx) {
      const cd = document.getElementById('duel-overlay-countdown');
      document.getElementById('duel-overlay-text').textContent = 'PREPARATI!';
      let count = 3; cd.textContent = count;
      const iv = setInterval(() => { count--; if (count <= 0) { clearInterval(iv); document.getElementById('duel-overlay').style.display = 'none'; startDuelPlayerRound(playerIdx) } else { cd.textContent = count } }, 1000);
    }
    function duelOverlayConfirm() { if (window._duelOverlayAction) { window._duelOverlayAction(); window._duelOverlayAction = null } }
    function startDuelPlayerRound(playerIdx) {
      duel.currentPlayer = playerIdx;
      // Each player gets their own independent target array
      const playerTargets = (playerIdx === 0 ? duel.targetsP1 : duel.targetsP2).slice();
      game = {
        type: 'duel', mode: duel.mode, bits: duel.bits, rounds: duel.rounds,
        aiuti: false, round: 0, errors: 0, streak: 0, maxStreak: 0, hintsUsed: 0, times: [],
        targets: playerTargets, bitState: [], roundDone: false, currentTarget: 0, currentMode: duel.mode, roundStart: 0, timerInterval: null
      };
      showScreen('train-play');
      document.getElementById('hint-btn').style.display = 'none';
      document.getElementById('campaign-hud').style.display = 'none';
      setupRoundUI(duel.mode === 'dec2bin'); nextRound();
    }
    function endDuelPlayerRound() {
      const correct = game.times.length; const totalTime = game.times.reduce((a, b) => a + b, 0);
      duel.results[duel.currentPlayer] = {
        correct, errors: game.errors, totalTime,
        avgTime: correct > 0 ? Math.round(totalTime / correct) : 0, maxStreak: game.maxStreak
      };
      if (duel.currentPlayer === 0) showDuelOverlay(1, 'intermission'); else showDuelResults();
    }
    function showDuelResults() {
      showScreen('results');
      const r0 = duel.results[0], r1 = duel.results[1]; let winner;
      if (r0.correct !== r1.correct) winner = r0.correct > r1.correct ? 0 : 1;
      else if (r0.totalTime !== r1.totalTime) winner = r0.totalTime < r1.totalTime ? 0 : 1;
      else winner = r0.errors <= r1.errors ? 0 : 1;
      document.getElementById('results-title').textContent = '⚔ DUELLO COMPLETATO';
      document.getElementById('results-subtitle').textContent = '🏆 Vincitore: ' + duel.players[winner].toUpperCase();
      document.getElementById('btn-next-level').style.display = 'none';
      function pRow(l, v0, v1) { return `<tr><td style="text-align:left;padding:6px;color:var(--text-dim)">${l}</td><td style="text-align:center;padding:6px;color:var(--accent);font-weight:bold">${v0}</td><td style="text-align:center;padding:6px;color:var(--duel);font-weight:bold">${v1}</td></tr>` }
      document.getElementById('results-stats').innerHTML = `<div style="grid-column:1/-1;overflow-x:auto;"><table style="width:100%;border-collapse:collapse;font-family:var(--font)"><thead><tr><th style="text-align:left;padding:8px;color:var(--text-dim);font-size:.7rem;letter-spacing:.1em">STATISTICA</th><th style="text-align:center;padding:8px;color:var(--accent);font-size:.8rem">${duel.players[0]}</th><th style="text-align:center;padding:8px;color:var(--duel);font-size:.8rem">${duel.players[1]}</th></tr></thead><tbody style="border-top:1px solid var(--border)">${pRow('Corrette', r0.correct + '/' + duel.rounds, r1.correct + '/' + duel.rounds)}${pRow('Tempo Totale', (r0.totalTime / 1000).toFixed(1) + 's', (r1.totalTime / 1000).toFixed(1) + 's')}${pRow('Tempo Medio', (r0.avgTime / 1000).toFixed(1) + 's', (r1.avgTime / 1000).toFixed(1) + 's')}${pRow('Errori', r0.errors, r1.errors)}${pRow('Streak Max', r0.maxStreak, r1.maxStreak)}</tbody></table></div>`;
      document.getElementById('results-extra').innerHTML = '<span style="font-size:1.2rem;color:var(--accent)">🏆 ' + duel.players[winner] + ' vince!</span>';
    }

    // ═══ TRAINING MODE ═══
    // UI aligned to referenze/allenamento
    function selectTrainMode(m) { /* handled via inline onchange on toggle checkboxes */ }
    function startTraining() {
      const d2b = document.getElementById('train-d2b');
      const mode = (d2b && d2b.checked) ? 'dec2bin' : 'bin2dec';
      const bits = parseInt(document.getElementById('train-bits').value);
      const rounds = parseInt(document.getElementById('train-rounds').value);
      const hintsOn = true;  // default on (Aiuti removed from reference UI)
      const timerOn = true;  // default on (Timer removed from reference UI)
      const targets = genTargetsNoSeed(bits, rounds);
      game = {
        type: 'training', mode: mode, bits: bits, rounds: rounds,
        aiuti: hintsOn, timerOn: timerOn,
        round: 0, errors: 0, streak: 0, maxStreak: 0, hintsUsed: 0, times: [],
        targets: targets, bitState: [], roundDone: false, currentTarget: 0, currentMode: mode,
        roundStart: 0, timerInterval: null
      };
      showScreen('train-play');
      document.getElementById('campaign-hud').style.display = 'none';
      document.getElementById('hint-btn').style.display = (hintsOn && mode === 'bin2dec') ? '' : 'none';
      setupRoundUI(mode === 'dec2bin');
      nextRound();
    }

    // ── TUTORIAL COMPLETED FLAG ──
    function markTutorialCompleted() {
      if (!store.settings.tutorialCompleted) {
        store.settings.tutorialCompleted = true;
        saveStore();
      }
    }

    // ── TRAINING HISTORY ──
    const TRAINING_KEY = 'binrush_training';
    const TRAINING_MAX = 100;
    function loadTrainingHistory() {
      try { const d = JSON.parse(localStorage.getItem(TRAINING_KEY)); return Array.isArray(d) ? d : [] } catch (e) { return [] }
    }
    function saveTrainingHistory(arr) {
      try { localStorage.setItem(TRAINING_KEY, JSON.stringify(arr)) } catch (e) { }
    }
    function saveTrainingSession(correct, rounds, errors, accPct, avgTimeMs, gm) {
      const arr = loadTrainingHistory();
      arr.push({
        ts: new Date().toISOString(),
        mode: gm.mode === 'dec2bin' ? 'DEC2BIN' : 'BIN2DEC',
        bits: gm.bits, rounds: rounds,
        correct: correct, errors: errors,
        accuracyPct: parseFloat((correct / rounds * 100).toFixed(1)),
        totalTimeSec: gm.timerOn ? parseFloat((gm.times.reduce((a, b) => a + b, 0) / 1000).toFixed(2)) : null,
        avgTimeSec: gm.timerOn && correct > 0 ? parseFloat((avgTimeMs / 1000).toFixed(2)) : null,
        hintsUsed: gm.hintsUsed,
        timerOn: !!gm.timerOn
      });
      if (arr.length > TRAINING_MAX) arr.splice(0, arr.length - TRAINING_MAX);
      saveTrainingHistory(arr);
    }
    function resetTrainingHistory() {
      if (!confirm('Cancellare tutto lo storico di allenamento?')) return;
      localStorage.removeItem(TRAINING_KEY);
      renderTrainingStats();
    }

    // ── TRAINING STATS ──
    // UI aligned to referenze/allenamento
    function renderTrainingStats() {
      const hist = loadTrainingHistory();
      const cardsEl = document.getElementById('tn-stats-cards');
      if (!cardsEl) return;
      const last10 = hist.slice(-10);
      const timedLast10 = last10.filter(s => s.timerOn && s.avgTimeSec != null);
      const allTimed = hist.filter(s => s.timerOn && s.avgTimeSec != null);
      const totalSessions = hist.length;
      const avgErr = last10.length > 0 ? (last10.reduce((a, s) => a + s.errors, 0) / last10.length).toFixed(1) : '--';
      const avgTime = timedLast10.length > 0 ? (timedLast10.reduce((a, s) => a + s.avgTimeSec, 0) / timedLast10.length).toFixed(1) : '--';
      const bestTime = allTimed.length > 0 ? Math.min(...allTimed.map(s => s.avgTimeSec)).toFixed(1) : '--';
      const sessBar = Math.min(100, totalSessions * 2.5);
      const errBar = avgErr !== '--' ? Math.min(100, parseFloat(avgErr) * 10) : 0;
      cardsEl.innerHTML =
        '<div class="tn-ref-card"><div class="tn-lbl">Sessioni</div><div class="tn-val">' + totalSessions + '</div><div class="tn-bar"><div class="tn-bar-fill" style="width:' + sessBar + '%"></div></div></div>' +
        '<div class="tn-ref-card"><div class="tn-lbl">Errori \u00d810</div><div class="tn-val txt-red">' + avgErr + '</div><div class="tn-bar"><div class="tn-bar-fill red" style="width:' + errBar + '%"></div></div></div>' +
        '<div class="tn-ref-card"><div class="tn-lbl">Tempo Medio</div><div class="tn-val">' + avgTime + (avgTime !== '--' ? 's' : '') + '</div><div class="tn-ref-extra green">\u2193 trend</div></div>' +
        '<div class="tn-ref-card"><div class="tn-lbl">Record</div><div class="tn-val txt-purple">' + bestTime + (bestTime !== '--' ? 's' : '') + '</div><div class="tn-ref-extra purple">\ud83c\udfc6 Best</div></div>';
      renderTrainingChart();
    }

    // ── TRAINING CHART ──
    let chartState = { metric: 'err', filter: 'all' };
    function setChartMetric(m) {
      chartState.metric = m;
      document.getElementById('chart-metric-err').classList.toggle('active', m === 'err');
      document.getElementById('chart-metric-time').classList.toggle('active', m === 'time');
      renderTrainingChart();
    }
    function setChartFilter(f) {
      chartState.filter = f;
      document.getElementById('chart-filter-all').classList.toggle('active', f === 'all');
      document.getElementById('chart-filter-10').classList.toggle('active', f === 10);
      document.getElementById('chart-filter-30').classList.toggle('active', f === 30);
      renderTrainingChart();
    }
    function renderTrainingChart() {
      if (renderTrainingChart._rendering) return;
      renderTrainingChart._rendering = true;
      const canvas = document.getElementById('training-chart');
      if (!canvas) { renderTrainingChart._rendering = false; return; }
      const ctx = canvas.getContext('2d');
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      canvas.width = rect.width * dpr;
      canvas.height = rect.height * dpr;
      ctx.scale(dpr, dpr);
      const W = rect.width, H = rect.height;
      ctx.clearRect(0, 0, W, H);
      let hist = loadTrainingHistory();
      // Filter: time metric → only timed sessions; errors → all sessions
      if (chartState.metric === 'time') hist = hist.filter(s => s.timerOn && s.avgTimeSec != null);
      // Apply count filter
      if (chartState.filter === 10) hist = hist.slice(-10);
      else if (chartState.filter === 30) hist = hist.slice(-30);
      if (hist.length < 2) {
        ctx.fillStyle = 'rgba(233,255,233,0.3)';
        ctx.font = '11px ' + getComputedStyle(document.documentElement).getPropertyValue('--font').trim();
        ctx.textAlign = 'center';
        ctx.fillText('Dati insufficienti (min. 2 sessioni)', W / 2, H / 2);
        // Remove stale listener
        canvas.onmousemove = null; canvas.onmouseleave = null;
        renderTrainingChart._rendering = false;
        return;
      }
      const pad = { t: 10, r: 10, b: 20, l: 36 };
      const gW = W - pad.l - pad.r, gH = H - pad.t - pad.b;
      const values = hist.map(s => chartState.metric === 'err' ? s.errors : s.avgTimeSec);
      const minV = Math.min(...values), maxV = Math.max(...values);
      const range = maxV - minV || 1;
      const yPad = range * 0.1;
      const yMin = Math.max(0, minV - yPad), yMax = maxV + yPad;
      const yRange = yMax - yMin || 1;
      // Get accent color from CSS
      const accent = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || '#3CFF78';
      const accentDim = getComputedStyle(document.documentElement).getPropertyValue('--accent-glow').trim() || 'rgba(60,255,120,0.35)';
      // Grid lines
      ctx.strokeStyle = 'rgba(60,255,120,0.08)';
      ctx.lineWidth = 1;
      for (let i = 0; i <= 4; i++) {
        const y = pad.t + (gH / 4) * i;
        ctx.beginPath(); ctx.moveTo(pad.l, y); ctx.lineTo(pad.l + gW, y); ctx.stroke();
        ctx.fillStyle = 'rgba(233,255,233,0.35)';
        ctx.font = '9px monospace';
        ctx.textAlign = 'right';
        const label = (yMax - (yRange / 4) * i).toFixed(chartState.metric === 'err' ? 0 : 1);
        ctx.fillText(label + (chartState.metric === 'err' ? '' : 's'), pad.l - 4, y + 3);
      }
      // Data points
      const pts = values.map((v, i) => ({
        x: pad.l + (i / (values.length - 1)) * gW,
        y: pad.t + gH - ((v - yMin) / yRange) * gH
      }));
      // Line
      ctx.strokeStyle = accent;
      ctx.lineWidth = 1.5;
      ctx.shadowColor = accent;
      ctx.shadowBlur = 4;
      ctx.beginPath();
      pts.forEach((p, i) => { if (i === 0) ctx.moveTo(p.x, p.y); else ctx.lineTo(p.x, p.y) });
      ctx.stroke();
      ctx.shadowBlur = 0;
      // Dots
      pts.forEach(p => {
        ctx.beginPath();
        ctx.arc(p.x, p.y, 3, 0, Math.PI * 2);
        ctx.fillStyle = accent;
        ctx.fill();
      });
      // Hover tooltip (non-recursive: overlay drawn directly on existing canvas)
      const chartData = { pts, hist, accent, W, H };
      canvas.onmousemove = function (e) {
        const cr = canvas.getBoundingClientRect();
        const mx = e.clientX - cr.left;
        let closest = -1, minDist = Infinity;
        chartData.pts.forEach((p, i) => { const d = Math.abs(p.x - mx); if (d < minDist) { minDist = d; closest = i } });
        if (closest >= 0 && minDist < 30) {
          if (canvas._lastTip === closest) return;
          canvas._lastTip = closest;
          // Redraw base chart (without tooltip)
          renderTrainingChart._guard = true;
          renderTrainingChart();
          renderTrainingChart._guard = false;
          // Now draw tooltip overlay
          const ctx2 = canvas.getContext('2d');
          const dpr2 = window.devicePixelRatio || 1;
          ctx2.save();
          ctx2.scale(dpr2, dpr2);
          const s = chartData.hist[closest], p = chartData.pts[closest];
          const a = chartData.accent;
          ctx2.beginPath(); ctx2.arc(p.x, p.y, 5, 0, Math.PI * 2);
          ctx2.fillStyle = a; ctx2.fill();
          ctx2.shadowColor = a; ctx2.shadowBlur = 8;
          ctx2.beginPath(); ctx2.arc(p.x, p.y, 5, 0, Math.PI * 2);
          ctx2.fill(); ctx2.shadowBlur = 0;
          const dd = new Date(s.ts);
          const dateStr = dd.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit' }) + ' ' + dd.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
          const precPct = s.rounds > 0 ? Math.round(((s.rounds - s.errors) / s.rounds) * 100) : 0;
          const tempoStr = (s.timerOn && s.avgTimeSec != null) ? s.avgTimeSec.toFixed(1) + 's' : '--';
          const lines = [
            dateStr + '  ' + s.mode + ' ' + s.bits + 'b',
            'Precisione: ' + precPct + '%  |  Tempo: ' + tempoStr + '  |  Errori: ' + s.errors + '/' + s.rounds
          ];
          const tipText = lines.join('  \u2022  ');
          ctx2.font = '10px monospace';
          const tw = ctx2.measureText(tipText).width + 12;
          const tx = Math.min(Math.max(p.x - tw / 2, 2), chartData.W - tw - 2);
          const ty = Math.max(p.y - 34, 2);
          ctx2.fillStyle = 'rgba(5,8,6,0.92)';
          ctx2.strokeStyle = a; ctx2.lineWidth = 1;
          ctx2.beginPath(); ctx2.roundRect(tx, ty, tw, 18, 3); ctx2.fill(); ctx2.stroke();
          ctx2.fillStyle = a; ctx2.textAlign = 'center';
          ctx2.fillText(tipText, tx + tw / 2, ty + 13);
          ctx2.restore();
        } else if (canvas._lastTip !== -1) {
          canvas._lastTip = -1;
          renderTrainingChart();
        }
      };
      canvas.onmouseleave = function () { canvas._lastTip = -1; renderTrainingChart() };
      renderTrainingChart._rendering = false;
    }

    // ═══ INIT ═══
    (function init() {
      if (!store.campaign) store.campaign = { currentLevel: 1, completed: [], starsByLevel: {}, bestStatsByLevel: {} };
      if (!store.campaign.completed) store.campaign.completed = [];
      if (!store.campaign.starsByLevel) store.campaign.starsByLevel = {};
      if (!store.campaign.bestStatsByLevel) store.campaign.bestStatsByLevel = {};
      if (!store.stats) store.stats = { sessions: 0, totalCorrect: 0, totalRounds: 0, bestAvgTime: null };
      if (store.settings.tutorialCompleted === undefined) store.settings.tutorialCompleted = false;
      applySettings(); renderProgressMap(); updateTopbarStats();
    })();
  </script>
</body>

</html>